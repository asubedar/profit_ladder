<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Charting (Live Ticker)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #131722; --panel-color: #1e222d; --border-color: #2a2e39;
            --text-color: #d1d4dc; --accent-color: #2962ff; --up-color: #26a69a; --down-color: #ef5350;
        }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* Toolbar */
        .toolbar { height: 40px; background-color: var(--panel-color); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 10px; gap: 15px; font-size: 13px; }
        .brand { font-weight: bold; color: var(--text-color); text-decoration: none; margin-right: 5px; }
        
        /* Inputs */
        .symbol-search input { background-color: #2a2e39; border: 1px solid #2a2e39; color: white; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; width: 80px; transition: 0.2s; }
        .symbol-search input:focus { border-color: var(--accent-color); outline: none; }
        
        /* Intervals */
        .intervals { display: flex; background: #131722; border-radius: 4px; padding: 2px; gap: 1px; flex-shrink: 0; }
        .interval-btn { background: none; border: none; color: #787b86; cursor: pointer; padding: 4px 8px; font-size: 12px; border-radius: 3px; }
        .interval-btn:hover { color: var(--text-color); background-color: #2a2e39; }
        .interval-btn.active { color: #fff; background-color: var(--accent-color); }

        /* SCROLLING TICKER (New) */
        .ticker-container {
            flex-grow: 1; /* Takes up all available space */
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        
        .ticker-track {
            display: flex;
            gap: 25px;
            animation: tickerScroll 45s linear infinite;
        }
        
        .ticker-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Monaco', monospace;
            font-size: 11px;
            cursor: pointer;
        }
        .ticker-item:hover { opacity: 0.8; }
        .t-sym { font-weight: bold; color: #d1d4dc; }
        .t-price { color: #d1d4dc; }
        .t-chg { font-weight: bold; }
        
        @keyframes tickerScroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        /* Helper Colors */
        .color-up { color: var(--up-color); } .color-down { color: var(--down-color); }

        /* Quote Strip */
        .quote-strip { height: 30px; background-color: #131722; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 15px; gap: 20px; font-family: 'Monaco', monospace; font-size: 12px; }
        .q-item { display: flex; gap: 5px; } .q-label { color: #787b86; } .q-val { color: #d1d4dc; font-weight: bold; }

        /* Chart Area */
        #chart-container { flex-grow: 1; position: relative; width: 100%; }
        .chart-legend { position: absolute; top: 10px; left: 10px; z-index: 20; font-size: 12px; font-family: monospace; pointer-events: none; }
        .legend-row { display: flex; gap: 15px; margin-bottom: 2px; }
        
        /* Loader */
        #history-loader { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: rgba(41, 98, 255, 0.9); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; z-index: 30; display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* Debug & Right Controls */
        #screen-logger { position: absolute; right: 0; top: 70px; bottom: 0; width: 350px; background: rgba(0,0,0,0.9); border-left: 1px solid #444; font-family: monospace; font-size: 11px; color: #0f0; padding: 10px; overflow-y: auto; z-index: 999; display: none; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; } .log-err { color: #f55; }
        .right-controls { margin-left: auto; display: flex; gap: 10px; flex-shrink: 0; background: var(--panel-color); z-index: 2; padding-left: 10px; } /* Added BG to cover ticker */
        .icon-btn { background: none; border: none; color: #787b86; cursor: pointer; font-size: 14px; }
        .icon-btn:hover { color: var(--text-color); }
    </style>
</head>
<body>

<div class="app-container">
    <div class="toolbar">
        <a href="./portfolio.html" class="brand"><i class="fas fa-chart-line"></i></a>
        <div class="symbol-search"><input type="text" id="tickerInput" value="AAPL"></div>
        <div class="intervals">
            <button class="interval-btn" data-tf="1Min">1m</button>
            <button class="interval-btn active" data-tf="5Min">5m</button>
            <button class="interval-btn" data-tf="15Min">15m</button>
            <button class="interval-btn" data-tf="1H">1h</button>
            <button class="interval-btn" data-tf="1D">D</button>
        </div>

        <div class="ticker-container" id="tickerContainer">
            <div class="ticker-track" id="tickerTrack">
                <span style="font-size:11px; color:#666;">Loading Portfolio...</span>
            </div>
        </div>

        <div class="right-controls">
            <button class="icon-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
            <button class="icon-btn" id="debugToggle"><i class="fas fa-bug"></i></button>
            <button class="icon-btn" id="settingsBtn"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div class="quote-strip">
        <div class="q-item"><span class="q-label">LAST:</span><span class="q-val" id="q-last">0.00</span></div>
        <div class="q-item"><span class="q-label">BID:</span><span class="q-val" id="q-bid">0.00</span></div>
        <div class="q-item"><span class="q-label">ASK:</span><span class="q-val" id="q-ask">0.00</span></div>
        <div class="q-item" style="margin-left: auto;"><span class="q-label">VOL:</span><span class="q-val" id="q-vol">0</span></div>
    </div>

    <div id="chart-container">
        <div id="history-loader"><i class="fas fa-circle-notch fa-spin"></i> Loading older data...</div>
        <div class="chart-legend">
            <div id="lg-header" style="font-weight:bold; font-size:1.2em; color: #787b86;">LOADING...</div>
            <div class="legend-row" id="lg-ohlc"></div>
            <div class="legend-row" id="lg-vol"></div>
        </div>
    </div>

    <div id="screen-logger">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><strong>System Logs</strong><button id="clearLogs">Clear</button></div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="shared.js"></script>

<script>
    // --- UTILS ---
    const logger = document.getElementById('screen-logger');
    function log(msg, type='info') {
        const div = document.createElement('div');
        div.className = 'log-line ' + (type === 'error' ? 'log-err' : '');
        div.innerText = `> ${msg}`;
        logger.appendChild(div);
        logger.scrollTop = logger.scrollHeight;
        if(type==='error') console.error(msg);
    }
    
    function formatNum(num) {
        if (!num) return '0';
        if (num >= 1000000) return (num/1000000).toFixed(2) + 'M';
        if (num >= 1000) return (num/1000).toFixed(1) + 'k';
        return Math.floor(num).toString();
    }

    // --- STATE ---
    const state = {
        ticker: 'AAPL', timeframe: '5Min', chart: null,
        series: { candle: null, volume: null },
        refreshInterval: null,
        masterData: [], earliestTime: null,
        isLoadingHistory: false, noMoreHistory: false, lastPrice: 0,
        portfolioTickers: []
    };

    // --- INIT ---
    async function init() {
        const el = document.getElementById('chart-container');
        
        state.chart = LightweightCharts.createChart(el, {
            layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
            timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#2a2e39', minBarSpacing: 0.005 },
            crosshair: { mode: 0 },
            rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.25 } },
        });

        state.series.volume = state.chart.addHistogramSeries({ 
            color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: 'volume_scale', 
        });
        state.chart.priceScale('volume_scale').applyOptions({ scaleMargins: { top: 0.75, bottom: 0 } });

        state.series.candle = state.chart.addCandlestickSeries({ 
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350' 
        });

        new ResizeObserver(e => {
            if (e.length && e[0].contentRect) state.chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height });
        }).observe(el);

        state.chart.subscribeCrosshairMove(updateLegend);
        state.chart.timeScale().subscribeVisibleLogicalRangeChange(onVisibleLogicalRangeChanged);

        log("Chart initialized.");
        
        // 1. LOAD SAVED STATE
        await loadSavedState();
        
        // 2. Load Data
        await loadInitialData(); 
        await initTickerTape();

        if (state.refreshInterval) clearInterval(state.refreshInterval);
        state.refreshInterval = setInterval(() => {
            updateRealtime();
            updateTickerTape(); 
        }, 3000);
    }

    // --- SAVING & LOADING STATE ---
    async function saveState() {
        try {
            const db = await new Promise((resolve, reject) => {
                const req = indexedDB.open("ProfitLadderDB", 3);
                req.onsuccess = e => resolve(e.target.result);
                req.onerror = e => reject(e);
            });
            const tx = db.transaction("Settings", "readwrite");
            const store = tx.objectStore("Settings");
            store.put({ key: "lastChartTicker", value: state.ticker });
            store.put({ key: "lastChartTimeframe", value: state.timeframe });
        } catch(e) { console.error("Failed to save state", e); }
    }

    async function loadSavedState() {
        try {
            const db = await new Promise((resolve, reject) => {
                const req = indexedDB.open("ProfitLadderDB", 3);
                req.onsuccess = e => resolve(e.target.result);
                req.onerror = e => reject(e);
            });
            const tx = db.transaction("Settings", "readonly");
            const store = tx.objectStore("Settings");
            
            const tReq = store.get("lastChartTicker");
            const tfReq = store.get("lastChartTimeframe");
            
            return new Promise((resolve) => {
                // Wait for both lookups
                let loaded = 0;
                const checkDone = () => {
                    loaded++;
                    if(loaded === 2) resolve();
                };

                tReq.onsuccess = () => {
                    if(tReq.result) {
                        state.ticker = tReq.result.value;
                        document.getElementById('tickerInput').value = state.ticker;
                    }
                    checkDone();
                };
                
                tfReq.onsuccess = () => {
                    if(tfReq.result) {
                        state.timeframe = tfReq.result.value;
                        // Update UI buttons
                        document.querySelectorAll('.interval-btn').forEach(btn => {
                            btn.classList.remove('active');
                            if(btn.dataset.tf === state.timeframe) btn.classList.add('active');
                        });
                    }
                    checkDone();
                };
                
                // Handle errors gracefully
                tReq.onerror = checkDone;
                tfReq.onerror = checkDone;
            });
        } catch(e) { console.error("Failed to load state", e); }
    }

    // --- TICKER TAPE LOGIC ---
    async function initTickerTape() {
        const keys = await getKeys();
        if(!keys) return;
        try {
            const db = await new Promise((resolve, reject) => {
                const req = indexedDB.open("ProfitLadderDB", 3);
                req.onsuccess = e => resolve(e.target.result);
                req.onerror = e => reject(e);
            });
            const tx = db.transaction("Positions", "readonly");
            const store = tx.objectStore("Positions");
            const req = store.getAll();
            req.onsuccess = async () => {
                const positions = req.result;
                if(positions && positions.length > 0) {
                    state.portfolioTickers = positions.map(p => p.tickerSymbol);
                    log(`Loaded ${state.portfolioTickers.length} tickers for tape.`);
                    updateTickerTape();
                } else {
                    document.getElementById('tickerTrack').innerHTML = '<span style="color:#444; font-size:11px; padding-left:10px;">Portfolio Empty</span>';
                }
            };
        } catch(e) { log("Error loading portfolio for tape: " + e.message); }
    }

    async function updateTickerTape() {
        if(state.portfolioTickers.length === 0) return;
        const keys = await getKeys();
        const symbols = state.portfolioTickers.join(',');
        const url = `https://data.alpaca.markets/v2/stocks/snapshots?symbols=${symbols}`;
        try {
            const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } });
            if(!res.ok) return;
            const json = await res.json();
            let html = '';
            state.portfolioTickers.sort().forEach(sym => {
                const data = json[sym];
                if(data && data.dailyBar && data.latestTrade) {
                    const price = data.latestTrade.p;
                    const prev = data.prevDailyBar ? data.prevDailyBar.c : price;
                    const chg = price - prev;
                    const pct = (chg / prev) * 100;
                    const colorClass = chg >= 0 ? 'color-up' : 'color-down';
                    const icon = chg >= 0 ? '▲' : '▼';
                    html += `
                        <div class="ticker-item" onclick="changeTicker('${sym}')">
                            <span class="t-sym">${sym}</span>
                            <span class="t-price">${price.toFixed(2)}</span>
                            <span class="t-chg ${colorClass}">${icon} ${Math.abs(pct).toFixed(2)}%</span>
                        </div>
                    `;
                }
            });
            // Dynamic duplication
            const track = document.getElementById('tickerTrack');
            if (state.portfolioTickers.length < 20) {
                track.innerHTML = html + html + html + html; 
            } else {
                track.innerHTML = html + html;
            }
        } catch(e) { }
    }
    
    window.changeTicker = function(sym) {
        document.getElementById('tickerInput').value = sym;
        state.ticker = sym;
        saveState(); // Save on click change
        loadInitialData();
    };

    // --- INFINITE SCROLL ---
    function onVisibleLogicalRangeChanged(newVisibleLogicalRange) {
        if (!newVisibleLogicalRange) return;
        if (newVisibleLogicalRange.from < 10 && !state.isLoadingHistory && !state.noMoreHistory) {
            loadOlderData();
        }
    }

    async function loadOlderData() {
        if (!state.earliestTime) return;
        state.isLoadingHistory = true;
        document.getElementById('history-loader').style.display = 'block';
        const keys = await getKeys();
        const logicalRange = state.chart.timeScale().getVisibleLogicalRange();
        const visibleBars = logicalRange ? Math.ceil(logicalRange.to - logicalRange.from) : 100;
        const dynamicLimit = Math.min(Math.max(visibleBars * 2, 500), 10000);
        const endStr = new Date((state.earliestTime - 1) * 1000).toISOString();
        const startStr = "2015-01-01T00:00:00Z";
        const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/bars?timeframe=${state.timeframe}&start=${startStr}&end=${endStr}&limit=${dynamicLimit}&sort=desc&adjustment=split`;
        try {
            const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } });
            const json = await res.json();
            if (json.bars && json.bars.length > 0) {
                const reversedBars = json.bars.reverse();
                const oldBars = parseBars(reversedBars);
                state.masterData = [...oldBars.ohlc, ...state.masterData];
                const newVolData = [...oldBars.vol, ...state.series.volume.data()]; 
                state.series.candle.setData(state.masterData);
                state.series.volume.setData(newVolData); 
                state.earliestTime = oldBars.ohlc[0].time;
                log(`Stitched ${json.bars.length} older bars.`);
            } else { state.noMoreHistory = true; }
        } catch(e) { log(e.message, 'error'); } 
        finally { state.isLoadingHistory = false; document.getElementById('history-loader').style.display = 'none'; }
    }

    // --- INITIAL DATA LOAD ---
    async function loadInitialData() {
        state.masterData = [];
        state.earliestTime = null;
        state.noMoreHistory = false;
        const keys = await getKeys();
        if (!keys) return;
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 30); 
        const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/bars?timeframe=${state.timeframe}&start=${start.toISOString()}&limit=10000&adjustment=split`;
        try {
            const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } });
            const json = await res.json();
            if (json.bars) {
                const data = parseBars(json.bars);
                state.masterData = data.ohlc;
                state.earliestTime = state.masterData[0].time;
                state.series.candle.setData(data.ohlc);
                state.series.volume.setData(data.vol);
                state.chart.timeScale().fitContent();
                document.getElementById('lg-header').innerText = `${state.ticker} · ${state.timeframe}`;
                if (data.ohlc.length > 0) state.lastPrice = data.ohlc[data.ohlc.length-1].close;
                updateRealtime();
            }
        } catch (e) { log(e.message, 'error'); }
    }

    // --- REALTIME UPDATES ---
    async function updateRealtime() {
        const keys = await getKeys();
        if (!keys) return;
        const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/snapshot`;
        try {
            const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } });
            if (!res.ok) return;
            const json = await res.json();
            const q = json.latestQuote;
            const t = json.latestTrade;
            const mb = json.minuteBar;
            const day = json.dailyBar;
            if (q) {
                document.getElementById('q-bid').innerText = `${q.bp.toFixed(2)}x${q.bs}`;
                document.getElementById('q-ask').innerText = `${q.ap.toFixed(2)}x${q.as}`;
            }
            if (t) {
                const el = document.getElementById('q-last');
                el.innerText = t.p.toFixed(2);
                el.className = 'q-val ' + (t.p >= state.lastPrice ? 'color-up' : 'color-down');
                state.lastPrice = t.p;
            }
            if (day) document.getElementById('q-vol').innerText = (day.v / 1000000).toFixed(2) + 'M';
            const currentData = state.series.candle.data();
            if (currentData.length === 0) return;
            const lastBar = currentData[currentData.length - 1];
            if (state.timeframe === '1D' && day) {
                const time = new Date(day.t).getTime() / 1000;
                if (time >= lastBar.time) updateChartBar(time, day.o, day.h, day.l, day.c, day.v);
            }
            else if (state.timeframe.includes('Min') && mb) {
                 const time = new Date(mb.t).getTime() / 1000;
                 updateChartBar(time, mb.o, mb.h, mb.l, mb.c, mb.v);
            }
            else if (state.timeframe === '1H' && t) {
                const price = t.p;
                const newHigh = Math.max(lastBar.high, price);
                const newLow = Math.min(lastBar.low, price);
                const currentVol = state.series.volume.data()[currentData.length - 1].value;
                updateChartBar(lastBar.time, lastBar.open, newHigh, newLow, price, currentVol);
            }
        } catch (e) { }
    }

    function updateChartBar(time, o, h, l, c, v) {
        state.series.candle.update({ time: time, open: o, high: h, low: l, close: c });
        state.series.volume.update({ time: time, value: v, color: (c >= o ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)') });
    }

    // --- PARSERS ---
    function parseBars(bars) {
        const ohlc = [];
        const vol = [];
        bars.forEach(b => {
            const t = new Date(b.t).getTime() / 1000;
            ohlc.push({ time: t, open: b.o, high: b.h, low: b.l, close: b.c });
            vol.push({ time: t, value: b.v, color: (b.c >= b.o ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)') });
        });
        return { ohlc, vol };
    }

    async function getKeys() {
        if (typeof getApiKeys !== 'function') return null;
        const keys = await getApiKeys();
        const k = keys.alpacaKey || keys.k || keys.APCA_API_KEY_ID;
        const s = keys.alpacaSecret || keys.s || keys.APCA_API_SECRET_KEY;
        if (!k || !s) return null;
        return { k, s };
    }

    function updateLegend(p) {
        if (!p.time) return;
        const c = p.seriesData.get(state.series.candle);
        const v = p.seriesData.get(state.series.volume);
        if (c) {
            const cl = c.close >= c.open ? 'color-up' : 'color-down';
            document.getElementById('lg-ohlc').innerHTML = `O:<span class="${cl}">${c.open.toFixed(2)}</span> H:<span class="${cl}">${c.high.toFixed(2)}</span> L:<span class="${cl}">${c.low.toFixed(2)}</span> C:<span class="${cl}">${c.close.toFixed(2)}</span>`;
        }
        if (v && c) {
            const dVol = v.value * c.close; 
            document.getElementById('lg-vol').innerHTML = `V: <span style="color:${v.color}">${formatNum(v.value)}</span> &nbsp;&nbsp; $V: <span style="color:#d1d4dc">$${formatNum(dVol)}</span>`;
        }
    }

    // --- EVENTS ---
    document.addEventListener('DOMContentLoaded', init);
    const input = document.getElementById('tickerInput');
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { 
            state.ticker = input.value.toUpperCase(); 
            saveState(); // Save change
            loadInitialData(); 
            input.blur(); 
        }
    });
    document.querySelectorAll('.interval-btn').forEach(b => b.addEventListener('click', () => {
        document.querySelectorAll('.interval-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active'); 
        state.timeframe = b.dataset.tf; 
        saveState(); // Save change
        loadInitialData();
    }));
    document.getElementById('debugToggle').addEventListener('click', () => logger.style.display = logger.style.display === 'block' ? 'none' : 'block');
    document.getElementById('refreshBtn').addEventListener('click', loadInitialData);
    document.getElementById('settingsBtn').addEventListener('click', () => alert("Manage keys in Portfolio Settings"));
    document.getElementById('clearLogs').addEventListener('click', () => logger.innerHTML = '');

</script>
</body>
</html>
