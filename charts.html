<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Charting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #131722;
            --panel-color: #1e222d;
            --border-color: #2a2e39;
            --text-color: #d1d4dc;
            --accent-color: #2962ff;
            --up-color: #26a69a;
            --down-color: #ef5350;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Navbar */
        .toolbar {
            height: 50px;
            background-color: var(--panel-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 15px;
        }

        .brand {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text-color);
            margin-right: 15px;
            text-decoration: none;
        }

        /* Ticker Input */
        .symbol-search input {
            background-color: #2a2e39;
            border: 1px solid transparent;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
            outline: none;
            width: 100px;
        }
        .symbol-search input:focus { border-color: var(--accent-color); }

        /* Timeframe Buttons */
        .intervals {
            display: flex;
            gap: 2px;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            padding: 0 10px;
        }
        .interval-btn {
            background: none;
            border: none;
            color: #787b86;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }
        .interval-btn:hover { color: var(--text-color); background-color: #2a2e39; }
        .interval-btn.active { color: var(--accent-color); background-color: rgba(41, 98, 255, 0.1); }

        /* Dropdowns */
        .dropdown { position: relative; cursor: pointer; font-size: 14px; }
        .dropdown-menu {
            position: absolute; top: 100%; left: 0;
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            border-radius: 4px; padding: 5px 0;
            min-width: 150px; display: none; z-index: 100;
        }
        .dropdown.open .dropdown-menu { display: block; }
        .dropdown-item { padding: 8px 15px; display: flex; align-items: center; gap: 8px; color: var(--text-color); }
        .dropdown-item:hover { background-color: #2a2e39; }

        /* Chart Area */
        #chart-container { flex-grow: 1; position: relative; width: 100%; }

        /* Legend */
        .chart-legend {
            position: absolute; top: 10px; left: 10px; z-index: 20;
            font-size: 12px; font-family: 'Monaco', 'Consolas', monospace; pointer-events: none;
        }
        .legend-row { margin-bottom: 4px; display: flex; gap: 10px; }
        .legend-ticker { font-size: 1.2em; font-weight: bold; }
        .color-up { color: var(--up-color); }
        .color-down { color: var(--down-color); }

        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 50; display: none;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="toolbar">
        <a href="./portfolio.html" class="brand"><i class="fas fa-chart-line"></i> Ladder</a>
        
        <div class="symbol-search">
            <input type="text" id="tickerInput" value="AAPL">
        </div>

        <div class="intervals">
            <button class="interval-btn" data-tf="1Min">1m</button>
            <button class="interval-btn active" data-tf="5Min">5m</button>
            <button class="interval-btn" data-tf="15Min">15m</button>
            <button class="interval-btn" data-tf="1H">1h</button>
            <button class="interval-btn" data-tf="1D">D</button>
        </div>

        <div class="dropdown" id="indicatorsDropdown">
            <span><i class="fas fa-layer-group"></i> Indicators</span>
            <div class="dropdown-menu">
                <div class="dropdown-item"><input type="checkbox" id="toggleVol" checked> <label for="toggleVol">Volume</label></div>
                <div class="dropdown-item"><input type="checkbox" id="toggleVWAP" checked> <label for="toggleVWAP">VWAP</label></div>
                <div class="dropdown-item"><input type="checkbox" id="toggleSMA"> <label for="toggleSMA">SMA 20</label></div>
                <div class="dropdown-item"><input type="checkbox" id="toggleEMA"> <label for="toggleEMA">EMA 9</label></div>
            </div>
        </div>
        
        <div style="flex-grow:1;"></div>
        
        <div class="dropdown">
            <span><i class="fas fa-cog"></i></span>
            <div class="dropdown-menu" style="right: 0; left: auto;">
               <div class="dropdown-item" id="openSettings">Manage Keys</div>
            </div>
        </div>
    </div>

    <div id="chart-container">
        <div id="loader"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
        <div class="chart-legend">
            <div class="legend-row">
                <span class="legend-ticker" id="lg-ticker">AAPL</span>
                <span id="lg-tf">5Min</span>
            </div>
            <div class="legend-row" id="lg-ohlc">
                O: <span class="legend-value">0.00</span> H: <span class="legend-value">0.00</span> 
                L: <span class="legend-value">0.00</span> C: <span class="legend-value">0.00</span> 
            </div>
            <div class="legend-row" id="lg-vol">Vol: <span class="legend-value">0</span></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script src="shared.js"></script>

<script>
    // --- Chart State ---
    const state = {
        ticker: 'AAPL', timeframe: '5Min', chart: null,
        series: { candle: null, volume: null, vwap: null, sma: null, ema: null }
    };

    // --- Math Helpers ---
    function calculateSMA(data, count){
        let result = [];
        for (let i=0; i < data.length; i++) {
            if (i < count-1) continue;
            let sum=0;
            for(let j=0;j<count;j++) sum += data[i-j].close;
            result.push({ time: data[i].time, value: sum/count });
        }
        return result;
    }

    function calculateEMA(data, count){
        if(data.length===0) return [];
        let result = [];
        let k = 2/(count+1);
        let ema = data[0].close;
        for (let i=0; i<data.length; i++) {
            ema = data[i].close * k + ema * (1-k);
            result.push({ time: data[i].time, value: ema });
        }
        return result;
    }

    // --- Chart Init ---
    function initChart() {
        const el = document.getElementById('chart-container');
        
        // FIX: Version 4.0 'background' syntax
        state.chart = LightweightCharts.createChart(el, {
            layout: { 
                background: { type: 'solid', color: '#131722' }, 
                textColor: '#d1d4dc' 
            },
            grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
            timeScale: { borderColor: '#2a2e39', timeVisible: true, secondsVisible: false },
        });

        // Add Series
        state.series.volume = state.chart.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '', scaleMargins: { top: 0.8, bottom: 0 } });
        state.series.candle = state.chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350' });
        state.series.vwap = state.chart.addLineSeries({ color: '#fb8c00', lineWidth: 1 });
        state.series.sma = state.chart.addLineSeries({ color: '#2962ff', lineWidth: 2 });
        state.series.ema = state.chart.addLineSeries({ color: '#e91e63', lineWidth: 2 });

        // Auto-Resize
        new ResizeObserver(e => {
            if (e.length && e[0].contentRect) state.chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height });
        }).observe(el);

        // Crosshair Legend
        state.chart.subscribeCrosshairMove(p => updateLegend(p));
    }

    // --- Data Fetching ---
    async function fetchData() {
        document.getElementById('loader').style.display = 'block';
        
        // CALL TO SHARED.JS
        // Ensure shared.js exports { alpacaKey, alpacaSecret } or { k, s }
        // We will adapt based on the variable names you likely have in shared.js
        const keys = await getApiKeys(); 
        
        // Handle different variable names from shared.js versions
        const apiKey = keys.alpacaKey || keys.k || keys.APCA_API_KEY_ID;
        const apiSecret = keys.alpacaSecret || keys.s || keys.APCA_API_SECRET_KEY;

        if (!apiKey || !apiSecret) {
            alert("No API Keys found! Go to Portfolio > Settings to save them.");
            document.getElementById('loader').style.display = 'none';
            return;
        }

        const end = new Date();
        const start = new Date();
        if(state.timeframe.includes('Min')) start.setDate(end.getDate() - 5);
        else start.setMonth(end.getMonth() - 6);

        const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/bars?timeframe=${state.timeframe}&start=${start.toISOString()}&limit=10000`;

        try {
            const res = await fetch(url, { headers: { "APCA-API-KEY-ID": apiKey, "APCA-API-SECRET-KEY": apiSecret } });
            
            if(!res.ok) {
                console.error("Alpaca Error:", res.status, res.statusText);
                document.getElementById('loader').style.display = 'none';
                return;
            }

            const json = await res.json();
            if(json.bars) {
                processData(json.bars);
            } else {
                console.warn("No data for " + state.ticker);
                state.series.candle.setData([]); // Clear chart
                state.series.volume.setData([]);
            }
        } catch(e) { console.error(e); }
        finally { document.getElementById('loader').style.display = 'none'; }
    }

    function processData(bars) {
        const ohlc = [], vol = [], vwap = [];
        bars.forEach(b => {
            const t = new Date(b.t).getTime() / 1000;
            ohlc.push({ time: t, open: b.o, high: b.h, low: b.l, close: b.c });
            vol.push({ time: t, value: b.v, color: (b.c >= b.o ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)') });
            if(b.vw) vwap.push({ time: t, value: b.vw });
        });

        state.series.candle.setData(ohlc);
        state.series.volume.setData(vol);
        state.series.vwap.setData(vwap);
        state.series.sma.setData(calculateSMA(ohlc, 20));
        state.series.ema.setData(calculateEMA(ohlc, 9));
        
        updateVisibility();
        state.chart.timeScale().fitContent();
    }

    function updateLegend(p) {
        if (!p.time) return;
        const c = p.seriesPrices.get(state.series.candle);
        const v = p.seriesPrices.get(state.series.volume);
        if (c) {
            const cl = c.close >= c.open ? 'color-up' : 'color-down';
            document.getElementById('lg-ohlc').innerHTML = `O: <span class="${cl}">${c.open.toFixed(2)}</span> H: <span class="${cl}">${c.high.toFixed(2)}</span> L: <span class="${cl}">${c.low.toFixed(2)}</span> C: <span class="${cl}">${c.close.toFixed(2)}</span>`;
        }
        if (v) document.getElementById('lg-vol').innerHTML = `Vol: <span class="legend-value">${Math.round(v).toLocaleString()}</span>`;
    }

    function updateVisibility() {
        state.series.volume.applyOptions({ visible: document.getElementById('toggleVol').checked });
        state.series.vwap.applyOptions({ visible: document.getElementById('toggleVWAP').checked });
        state.series.sma.applyOptions({ visible: document.getElementById('toggleSMA').checked });
        state.series.ema.applyOptions({ visible: document.getElementById('toggleEMA').checked });
    }

    // --- Init ---
    initChart();
    
    // Give shared.js a moment to init DB connection
    setTimeout(fetchData, 500);

    // --- Event Listeners ---
    const input = document.getElementById('tickerInput');

    // 1. Enter Key Listener (Fixes the issue where typing didn't work)
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            state.ticker = input.value.toUpperCase();
            document.getElementById('lg-ticker').innerText = state.ticker;
            fetchData();
            input.blur(); // Remove focus
        }
    });

    document.querySelectorAll('.interval-btn').forEach(b => b.addEventListener('click', () => {
        document.querySelectorAll('.interval-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
        state.timeframe = b.dataset.tf;
        document.getElementById('lg-tf').innerText = b.innerText;
        fetchData();
    }));

    document.querySelectorAll('.dropdown').forEach(d => d.addEventListener('click', e => {
        d.classList.toggle('open'); e.stopPropagation();
    }));
    document.addEventListener('click', () => document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open')));
    
    ['toggleVol', 'toggleVWAP', 'toggleSMA', 'toggleEMA'].forEach(id => document.getElementById(id).addEventListener('change', updateVisibility));
    
    document.getElementById('openSettings').addEventListener('click', () => alert("Go to Portfolio > Settings to manage keys."));

</script>
</body>
</html>
