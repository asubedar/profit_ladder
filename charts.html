<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ladder Charts (Debug Mode)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #131722;
            --panel-color: #1e222d;
            --border-color: #2a2e39;
            --text-color: #d1d4dc;
            --accent-color: #2962ff;
        }

        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--bg-color); color: var(--text-color); font-family: sans-serif; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* Toolbar */
        .toolbar { height: 50px; background-color: var(--panel-color); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 15px; gap: 15px; }
        .brand { font-weight: bold; color: var(--text-color); text-decoration: none; }
        .symbol-search input { background-color: #2a2e39; border: 1px solid transparent; color: white; padding: 6px 10px; border-radius: 4px; text-transform: uppercase; font-weight: bold; width: 100px; }
        
        /* Timeframe Buttons */
        .intervals { display: flex; gap: 2px; }
        .interval-btn { background: none; border: none; color: #787b86; cursor: pointer; padding: 5px 8px; font-size: 13px; }
        .interval-btn.active { color: var(--accent-color); background-color: rgba(41, 98, 255, 0.1); }

        /* Chart Area */
        #chart-container { flex-grow: 1; position: relative; width: 100%; }
        
        /* On-Screen Logger (DEBUG) */
        #screen-logger {
            position: absolute; right: 0; top: 50px; bottom: 0; width: 300px;
            background: rgba(0,0,0,0.8); border-left: 1px solid #444;
            font-family: monospace; font-size: 12px; color: #0f0;
            padding: 10px; overflow-y: auto; z-index: 999;
            pointer-events: none; /* Click through */
        }
        .log-line { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-err { color: #f55; }
        .log-warn { color: #fb0; }
        
        /* Legend */
        .chart-legend { position: absolute; top: 10px; left: 10px; z-index: 20; font-size: 12px; font-family: monospace; pointer-events: none; }
        .color-up { color: #26a69a; } .color-down { color: #ef5350; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="toolbar">
        <a href="./portfolio.html" class="brand"><i class="fas fa-chart-line"></i> Ladder</a>
        <div class="symbol-search"><input type="text" id="tickerInput" value="AAPL"></div>
        <div class="intervals">
            <button class="interval-btn" data-tf="1Min">1m</button>
            <button class="interval-btn active" data-tf="5Min">5m</button>
            <button class="interval-btn" data-tf="15Min">15m</button>
            <button class="interval-btn" data-tf="1H">1h</button>
        </div>
        <div style="flex-grow:1;"></div>
        <button id="clearLogs" style="background:#333; color:#fff; border:none; cursor:pointer;">Clear Log</button>
    </div>

    <div id="chart-container">
        <div class="chart-legend">
            <div id="lg-header" style="font-weight:bold; font-size:1.2em;">Initializing...</div>
            <div id="lg-ohlc">Waiting for data...</div>
        </div>
    </div>
    
    <div id="screen-logger"><strong>System Logs:</strong><br></div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="shared.js"></script>

<script>
    // --- DEBUG LOGGER ---
    function log(msg, type='info') {
        const box = document.getElementById('screen-logger');
        const div = document.createElement('div');
        div.className = 'log-line ' + (type === 'error' ? 'log-err' : type === 'warn' ? 'log-warn' : '');
        div.innerText = `> ${msg}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        console.log(msg);
    }

    // --- CHART STATE ---
    const state = {
        ticker: 'AAPL', timeframe: '5Min', chart: null,
        series: { candle: null, volume: null }
    };

    // --- INITIALIZATION ---
    async function init() {
        log("Initializing Chart...");
        
        // 1. Setup Chart
        const el = document.getElementById('chart-container');
        try {
            state.chart = LightweightCharts.createChart(el, {
                layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
                timeScale: { timeVisible: true, secondsVisible: false },
            });
            
            state.series.volume = state.chart.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '', scaleMargins: { top: 0.8, bottom: 0 } });
            state.series.candle = state.chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350' });
            
            new ResizeObserver(e => {
                if (e.length && e[0].contentRect) state.chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height });
            }).observe(el);
            
            state.chart.subscribeCrosshairMove(updateLegend);
            log("Chart created successfully.");
        } catch (e) {
            log("CRITICAL: Failed to create chart. " + e.message, 'error');
            return;
        }

        // 2. Fetch Data
        await fetchData();
    }

    // --- DATA FETCHING ---
    async function fetchData() {
        log(`Fetching data for ${state.ticker} (${state.timeframe})...`);
        
        // Check shared.js connection
        if (typeof getApiKeys !== 'function') {
            log("ERROR: 'getApiKeys' not found. Is shared.js loaded?", 'error');
            return;
        }

        const keys = await getApiKeys();
        log("DB Keys Retrieved: " + JSON.stringify(Object.keys(keys)));

        // Handle variations in key names
        const apiKey = keys.alpacaKey || keys.k || keys.APCA_API_KEY_ID;
        const apiSecret = keys.alpacaSecret || keys.s || keys.APCA_API_SECRET_KEY;

        if (!apiKey || !apiSecret) {
            log("MISSING KEYS: Go to Portfolio page settings.", 'error');
            alert("Missing API Keys!");
            return;
        }

        // Build URL
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - 5); // Simple 5 day lookback
        
        const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/bars?timeframe=${state.timeframe}&start=${start.toISOString()}&limit=1000`;
        
        log(`Requesting: ${url}`);

        try {
            const res = await fetch(url, { headers: { "APCA-API-KEY-ID": apiKey, "APCA-API-SECRET-KEY": apiSecret } });
            
            log(`HTTP Status: ${res.status} ${res.statusText}`);
            
            if (!res.ok) {
                const txt = await res.text();
                log(`API ERROR BODY: ${txt}`, 'error');
                return;
            }

            const json = await res.json();
            log(`Data received. Bars count: ${json.bars ? json.bars.length : 0}`);

            if (json.bars && json.bars.length > 0) {
                processData(json.bars);
            } else {
                log("No bars returned from API.", 'warn');
            }

        } catch (e) {
            log("FETCH EXCEPTION: " + e.message, 'error');
        }
    }

    function processData(bars) {
        const ohlc = [];
        const vol = [];
        
        bars.forEach(b => {
            const t = new Date(b.t).getTime() / 1000;
            ohlc.push({ time: t, open: b.o, high: b.h, low: b.l, close: b.c });
            vol.push({ time: t, value: b.v, color: (b.c >= b.o ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)') });
        });

        state.series.candle.setData(ohlc);
        state.series.volume.setData(vol);
        state.chart.timeScale().fitContent();
        log("Chart updated.");
        
        // Update Header
        document.getElementById('lg-header').innerText = `${state.ticker} ${state.timeframe}`;
    }

    function updateLegend(p) {
        if (!p.time) return;
        const c = p.seriesPrices.get(state.series.candle);
        if (c) {
            const cl = c.close >= c.open ? 'color-up' : 'color-down';
            document.getElementById('lg-ohlc').innerHTML = `O:<span class="${cl}">${c.open}</span> H:<span class="${cl}">${c.high}</span> L:<span class="${cl}">${c.low}</span> C:<span class="${cl}">${c.close}</span>`;
        }
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', init);

    const input = document.getElementById('tickerInput');
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            state.ticker = input.value.toUpperCase();
            fetchData();
            input.blur();
        }
    });

    document.querySelectorAll('.interval-btn').forEach(b => b.addEventListener('click', () => {
        document.querySelectorAll('.interval-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
        state.timeframe = b.dataset.tf;
        fetchData();
    }));

    document.getElementById('clearLogs').addEventListener('click', () => {
        document.getElementById('screen-logger').innerHTML = '<strong>System Logs:</strong><br>';
    });

</script>
</body>
</html>
