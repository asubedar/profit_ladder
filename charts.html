<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Charting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #131722;
            --panel-color: #1e222d;
            --border-color: #2a2e39;
            --text-color: #d1d4dc;
            --accent-color: #2962ff;
            --up-color: #26a69a;
            --down-color: #ef5350;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden; /* Prevent page scroll */
        }

        /* Layout Grid */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Navbar (Top Strip) */
        .toolbar {
            height: 50px;
            background-color: var(--panel-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 15px;
        }

        .brand {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text-color);
            margin-right: 15px;
            text-decoration: none;
        }

        /* Ticker Input */
        .symbol-search {
            position: relative;
        }
        .symbol-search input {
            background-color: #2a2e39;
            border: 1px solid transparent;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
            outline: none;
            width: 100px;
            transition: border 0.2s;
        }
        .symbol-search input:focus {
            border-color: var(--accent-color);
        }

        /* Timeframe Buttons */
        .intervals {
            display: flex;
            gap: 2px;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            padding: 0 10px;
        }
        .interval-btn {
            background: none;
            border: none;
            color: #787b86;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }
        .interval-btn:hover {
            color: var(--text-color);
            background-color: #2a2e39;
        }
        .interval-btn.active {
            color: var(--accent-color);
            background-color: rgba(41, 98, 255, 0.1);
        }

        /* Dropdowns (Indicators) */
        .dropdown {
            position: relative;
            cursor: pointer;
            font-size: 14px;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 0;
            min-width: 150px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .dropdown.open .dropdown-menu {
            display: block;
        }
        .dropdown-item {
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
        }
        .dropdown-item:hover {
            background-color: #2a2e39;
        }

        /* Main Chart Area */
        #chart-container {
            flex-grow: 1;
            position: relative;
            width: 100%;
        }

        /* Floating Legend */
        .chart-legend {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 20;
            font-size: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            pointer-events: none; /* Let clicks pass through to chart */
        }
        .legend-row {
            margin-bottom: 4px;
            display: flex;
            gap: 10px;
        }
        .legend-ticker { font-size: 1.2em; font-weight: bold; }
        .legend-value { color: var(--text-color); }
        .legend-label { font-weight: bold; margin-right: 4px; }
        
        .color-up { color: var(--up-color); }
        .color-down { color: var(--down-color); }

        /* Loading Spinner */
        #loader {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            display: none;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="toolbar">
        <a href="./portfolio.html" class="brand"><i class="fas fa-chart-line"></i> Ladder</a>
        
        <div class="symbol-search">
            <input type="text" id="tickerInput" value="AAPL">
        </div>

        <div class="intervals" id="intervalContainer">
            <button class="interval-btn" data-tf="1Min">1m</button>
            <button class="interval-btn active" data-tf="5Min">5m</button>
            <button class="interval-btn" data-tf="15Min">15m</button>
            <button class="interval-btn" data-tf="1H">1h</button>
            <button class="interval-btn" data-tf="1D">D</button>
        </div>

        <div class="dropdown" id="indicatorsDropdown">
            <span><i class="fas fa-layer-group"></i> Indicators</span>
            <div class="dropdown-menu">
                <div class="dropdown-item">
                    <input type="checkbox" id="toggleVol" checked> <label for="toggleVol">Volume</label>
                </div>
                <div class="dropdown-item">
                    <input type="checkbox" id="toggleVWAP" checked> <label for="toggleVWAP">VWAP</label>
                </div>
                <div class="dropdown-item">
                    <input type="checkbox" id="toggleSMA"> <label for="toggleSMA">SMA 20</label>
                </div>
                <div class="dropdown-item">
                    <input type="checkbox" id="toggleEMA"> <label for="toggleEMA">EMA 9</label>
                </div>
            </div>
        </div>
        
        <div style="flex-grow:1;"></div> <div class="dropdown" id="settingsDropdown">
            <span><i class="fas fa-cog"></i></span>
            <div class="dropdown-menu" style="right: 0; left: auto;">
               <div class="dropdown-item" id="openSettings">API Keys</div>
            </div>
        </div>
    </div>

    <div id="chart-container">
        <div id="loader"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
        
        <div class="chart-legend" id="legend">
            <div class="legend-row">
                <span class="legend-ticker" id="lg-ticker">AAPL</span>
                <span id="lg-tf">5m</span>
                <span id="lg-status" style="color: #666;">- Market Closed</span>
            </div>
            <div class="legend-row" id="lg-ohlc">
                O: <span class="legend-value">0.00</span> 
                H: <span class="legend-value">0.00</span> 
                L: <span class="legend-value">0.00</span> 
                C: <span class="legend-value">0.00</span> 
            </div>
            <div class="legend-row" id="lg-vol">
                Vol: <span class="legend-value">0</span>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<script src="shared.js"></script>

<script>
    // --- State Management ---
    const state = {
        ticker: 'AAPL',
        timeframe: '5Min',
        chart: null,
        series: {
            candle: null,
            volume: null,
            vwap: null,
            sma: null,
            ema: null
        },
        data: {
            ohlc: [],
            volume: []
        },
        indicators: {
            vwap: true,
            volume: true,
            sma: false,
            ema: false
        }
    };

    // --- Indicator Logic (Client Side Calculation) ---
    const Indicators = {
        calculateSMA: (data, period) => {
            let result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    continue; 
                }
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                result.push({ time: data[i].time, value: sum / period });
            }
            return result;
        },
        calculateEMA: (data, period) => {
            let result = [];
            let k = 2 / (period + 1);
            let ema = data[0].close;
            for (let i = 0; i < data.length; i++) {
                ema = data[i].close * k + ema * (1 - k);
                result.push({ time: data[i].time, value: ema });
            }
            return result;
        }
    };

    // --- Chart Initialization ---
    function initChart() {
        const container = document.getElementById('chart-container');
        
        state.chart = LightweightCharts.createChart(container, {
            layout: {
                backgroundColor: '#131722',
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#1e222d' },
                horzLines: { color: '#1e222d' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            timeScale: {
                borderColor: '#2a2e39',
                timeVisible: true,
                secondsVisible: false,
            },
            rightPriceScale: {
                borderColor: '#2a2e39',
            },
        });

        // 1. Volume Series (Added first so it sits behind candles)
        state.series.volume = state.chart.addHistogramSeries({
            color: '#26a69a',
            priceFormat: { type: 'volume' },
            priceScaleId: '', // Overlay mode
            scaleMargins: { top: 0.8, bottom: 0 },
        });

        // 2. Candlestick Series
        state.series.candle = state.chart.addCandlestickSeries({
            upColor: '#26a69a',
            downColor: '#ef5350',
            borderVisible: false,
            wickUpColor: '#26a69a',
            wickDownColor: '#ef5350',
        });

        // 3. Indicators
        state.series.vwap = state.chart.addLineSeries({ color: '#fb8c00', lineWidth: 1, title: 'VWAP' });
        state.series.sma = state.chart.addLineSeries({ color: '#2962ff', lineWidth: 2, title: 'SMA 20' });
        state.series.ema = state.chart.addLineSeries({ color: '#e91e63', lineWidth: 2, title: 'EMA 9' });

        // Responsive Resize
        new ResizeObserver(entries => {
            if (entries.length === 0 || entries[0].target !== container) { return; }
            const newRect = entries[0].contentRect;
            state.chart.applyOptions({ height: newRect.height, width: newRect.width });
        }).observe(container);

        // Crosshair Handler for Legend
        state.chart.subscribeCrosshairMove(param => {
            updateLegend(param);
        });
    }

    // --- Data Fetching ---
    async function fetchData() {
        document.getElementById('loader').style.display = 'block';
        const { alpacaKey, alpacaSecret } = await getApiKeys(); // From shared.js

        if (!alpacaKey) {
            alert("API Keys missing! Check Settings.");
            document.getElementById('loader').style.display = 'none';
            return;
        }

        // Calculate date range based on timeframe
        const end = new Date();
        const start = new Date();
        if(state.timeframe.includes('Min')) start.setDate(end.getDate() - 5);
        else if(state.timeframe.includes('H')) start.setMonth(end.getMonth() - 2);
        else start.setFullYear(end.getFullYear() - 2);

        const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/bars?timeframe=${state.timeframe}&start=${start.toISOString()}&limit=10000`;

        try {
            const response = await fetch(url, {
                headers: {
                    "APCA-API-KEY-ID": alpacaKey,
                    "APCA-API-SECRET-KEY": alpacaSecret
                }
            });
            const json = await response.json();
            
            if(json.bars) {
                processData(json.bars);
            }
        } catch(e) {
            console.error(e);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function processData(bars) {
        const ohlc = [];
        const volume = [];
        const vwap = [];

        bars.forEach(bar => {
            const time = new Date(bar.t).getTime() / 1000;
            ohlc.push({ time, open: bar.o, high: bar.h, low: bar.l, close: bar.c });
            
            // Color volume based on previous close
            const color = (bar.c >= bar.o) ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)';
            volume.push({ time, value: bar.v, color: color });

            if(bar.vw) vwap.push({ time, value: bar.vw });
        });

        // Store raw data
        state.data.ohlc = ohlc;

        // Set Main Series
        state.series.candle.setData(ohlc);
        state.series.volume.setData(volume);

        // Set Indicators
        if(vwap.length > 0) state.series.vwap.setData(vwap);
        
        // Calculate Client-Side Indicators
        const smaData = Indicators.calculateSMA(ohlc, 20);
        state.series.sma.setData(smaData);

        const emaData = Indicators.calculateEMA(ohlc, 9);
        state.series.ema.setData(emaData);

        // Apply Visibility based on checkboxes
        updateVisibility();
    }

    // --- UI Logic ---
    function updateLegend(param) {
        const lgOhlc = document.getElementById('lg-ohlc');
        const lgVol = document.getElementById('lg-vol');
        
        if (param.time) {
            const data = param.seriesPrices.get(state.series.candle);
            const vol = param.seriesPrices.get(state.series.volume);
            
            if(data) {
                const colorClass = data.close >= data.open ? 'color-up' : 'color-down';
                lgOhlc.innerHTML = `
                    O: <span class="${colorClass}">${data.open.toFixed(2)}</span> 
                    H: <span class="${colorClass}">${data.high.toFixed(2)}</span> 
                    L: <span class="${colorClass}">${data.low.toFixed(2)}</span> 
                    C: <span class="${colorClass}">${data.close.toFixed(2)}</span>`;
            }
            if(vol) {
                lgVol.innerHTML = `Vol: <span class="legend-value">${(vol).toLocaleString()}</span>`;
            }
        } else {
            // Revert to last bar if not hovering
            // (Optional: Implement Logic to show last bar data)
        }
    }

    function updateVisibility() {
        state.series.volume.applyOptions({ visible: document.getElementById('toggleVol').checked });
        state.series.vwap.applyOptions({ visible: document.getElementById('toggleVWAP').checked });
        state.series.sma.applyOptions({ visible: document.getElementById('toggleSMA').checked });
        state.series.ema.applyOptions({ visible: document.getElementById('toggleEMA').checked });
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        initChart();
        fetchData(); // Initial Fetch

        // Ticker Input
        const tickerInput = document.getElementById('tickerInput');
        tickerInput.addEventListener('change', (e) => {
            state.ticker = e.target.value.toUpperCase();
            document.getElementById('lg-ticker').innerText = state.ticker;
            fetchData();
        });

        // Timeframe Buttons
        const btns = document.querySelectorAll('.interval-btn');
        btns.forEach(btn => {
            btn.addEventListener('click', () => {
                btns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.timeframe = btn.dataset.tf;
                document.getElementById('lg-tf').innerText = btn.innerText;
                fetchData();
            });
        });

        // Dropdowns
        document.querySelectorAll('.dropdown').forEach(d => {
            d.addEventListener('click', (e) => {
                // Close others
                document.querySelectorAll('.dropdown').forEach(x => {
                    if(x !== d) x.classList.remove('open');
                });
                d.classList.toggle('open');
                e.stopPropagation();
            });
        });

        // Close dropdowns on click outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
        });

        // Indicator Toggles
        document.getElementById('toggleVol').addEventListener('change', updateVisibility);
        document.getElementById('toggleVWAP').addEventListener('change', updateVisibility);
        document.getElementById('toggleSMA').addEventListener('change', updateVisibility);
        document.getElementById('toggleEMA').addEventListener('change', updateVisibility);
        
        // Open Settings (Simple alert for now, connects to shared logic ideally)
        document.getElementById('openSettings').addEventListener('click', () => {
             alert("To update API keys, please go back to the Portfolio page.");
        });
    });

</script>
</body>
</html>
