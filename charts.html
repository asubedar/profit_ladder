<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Charting (Emergency Fix)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #131722; --panel-color: #1e222d; --border-color: #2a2e39;
            --text-color: #d1d4dc; --accent-color: #2962ff; --up-color: #26a69a; --down-color: #ef5350;
        }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; }
        
        /* EMERGENCY BUTTON - ALWAYS VISIBLE */
        #emergency-btn {
            position: fixed; top: 10px; left: 10px; z-index: 100000;
            background: #d50000; color: white; padding: 10px 20px;
            border: 2px solid white; border-radius: 4px; cursor: pointer;
            font-weight: bold; font-family: sans-serif;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #emergency-btn:hover { background: #ff1744; }

        /* LAYOUT */
        .app-container { display: grid; grid-template-rows: 40px 30px 1fr; height: 100vh; width: 100vw; overflow: hidden; }
        .toolbar { background-color: var(--panel-color); border-bottom: 1px solid var(--border-color); display: grid; grid-template-columns: auto minmax(0, 1fr) auto; align-items: center; padding: 0 10px 0 140px; /* Padding left for button */ gap: 15px; z-index: 200; }
        .left-controls, .right-controls { display: flex; gap: 10px; align-items: center; white-space: nowrap; }
        .right-controls { margin-left: auto; }
        .brand { font-weight: bold; color: var(--text-color); text-decoration: none; margin-right: 5px; font-size: 14px; }

        /* TAPE */
        .ticker-container { position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; align-items: center; margin: 0 10px; min-width: 0; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .ticker-track { display: flex; gap: 20px; animation: tickerScroll 90s linear infinite; align-items: center; height: 100%; }
        .ticker-item { display: flex; align-items: center; gap: 6px; font-family: 'Monaco', monospace; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .t-sym { font-weight: bold; color: #d1d4dc; } .t-price { color: #d1d4dc; } .t-chg { font-weight: bold; }
        @keyframes tickerScroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        /* NEWS */
        .news-strip { background-color: #131722; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; overflow: hidden; white-space: nowrap; position: relative; font-family: 'Roboto', sans-serif; font-size: 12px; z-index: 190; }
        .news-label { background: #2962ff; color: white; font-weight: bold; padding: 0 10px; height: 100%; display: flex; align-items: center; font-size: 11px; z-index: 2; box-shadow: 5px 0 10px #131722; }
        .news-track { display: flex; gap: 40px; animation: tickerScroll 120s linear infinite; padding-left: 20px; align-items: center; height: 100%; }
        .news-item { display: flex; align-items: center; gap: 8px; color: #d1d4dc; text-decoration: none; cursor: pointer; }
        .news-sym { color: #ff9800; font-weight: bold; font-size: 10px; border: 1px solid #ff9800; padding: 1px 4px; border-radius: 3px; }
        .news-time { color: #787b86; font-size: 10px; }

        /* WORKSPACE */
        .workspace { display: flex; flex-grow: 1; overflow: hidden; position: relative; z-index: 1; height: 100%; }
        #main-area { flex-grow: 1; display: grid; grid-template-columns: 1fr; grid-template-rows: 1fr; gap: 1px; background-color: var(--border-color); height: 100%; min-width: 0; overflow: hidden; }
        
        /* SIDEBARS */
        #left-sidebar-area, #right-sidebar-area { width: 280px; min-width: 280px; background-color: #131722; display: flex; flex-direction: column; flex-shrink: 0; transition: all 0.2s ease-out; overflow: hidden; height: 100%; }
        #left-sidebar-area { border-right: 1px solid var(--border-color); }
        #right-sidebar-area { border-left: 1px solid var(--border-color); }
        .collapsed { width: 0 !important; min-width: 0 !important; border: none !important; }

        /* SLOT */
        .chart-slot, .widget-box { position: relative; background-color: var(--bg-color); min-width: 0; min-height: 0; display: flex; flex-direction: column; overflow: hidden; border-bottom: 1px solid var(--border-color); flex: 1; }
        
        /* HEADER */
        .widget-header { height: 34px; min-height: 34px; background-color: var(--panel-color); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 6px; gap: 4px; flex-shrink: 0; z-index: 30; white-space: nowrap; overflow: visible; }
        .widget-controls-left { display: flex; flex-direction: row; gap: 4px; align-items: center; flex-shrink: 0; }
        .mini-input { background: rgba(42, 46, 57, 0.9); border: 1px solid #444; color: #fff; width: 55px; font-size: 11px; text-transform: uppercase; border-radius: 3px; padding: 3px 0; font-weight: bold; text-align: center; height: 24px; box-sizing: border-box; }
        .link-btn, .type-btn { width: 24px; min-width: 24px; height: 24px; border-radius: 3px; cursor: pointer; border: 1px solid #444; background: rgba(42, 46, 57, 0.9); display: flex; align-items: center; justify-content: center; font-size: 10px; color: #777; flex-shrink: 0; }
        
        /* L1 */
        .l1-overlay { position: absolute; top: 6px; right: 60px; z-index: 25; display: flex; gap: 4px; align-items: center; font-family: 'Roboto', sans-serif; pointer-events: none; }
        .l1-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 50px; height: 24px; border-radius: 3px; color: white; cursor: default; box-shadow: 0 2px 5px rgba(0,0,0,0.4); font-size: 10px; line-height: 1; pointer-events: auto; }
        .l1-bid { background: #ef5350; } .l1-ask { background: #2962ff; } 
        .l1-center { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 55px; height: 24px; background: rgba(30, 34, 45, 0.9); border-radius: 3px; pointer-events: auto; }
        .l1-price { font-size: 11px; font-weight: bold; line-height: 1; }
        .l1-size { font-size: 9px; opacity: 0.8; line-height: 1; }
        .last-price { font-size: 13px; font-weight: bold; color: #d1d4dc; line-height: 1; }
        .day-vol { font-size: 9px; color: #787b86; margin-top: 1px; font-family: 'Monaco', monospace; }
        #left-sidebar-area .l1-overlay, #right-sidebar-area .l1-overlay { display: none; }

        /* CONTENT */
        .widget-content { flex: 1; position: relative; display: flex; flex-direction: column; min-height: 0; background: #131722; overflow: hidden; }
        .chart-canvas-fill { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; }
        .chart-legend { position: absolute; top: 8px; left: 8px; z-index: 20; font-size: 11px; font-family: monospace; pointer-events: none; }
        .legend-row { display: flex; gap: 10px; margin-bottom: 2px; }

        .tape-content { flex: 1; overflow-y: auto; font-family: 'Monaco', monospace; font-size: 12px; background: #131722; margin: 0; padding: 0; }
        .tape-header-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 4px 8px; border-bottom: 1px solid #2a2e39; background: #161a25; font-size: 10px; color: #787b86; flex-shrink: 0; }
        .tape-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 3px 8px; border-bottom: 1px solid #1e222d; cursor: default; }
        .tape-row:hover { background-color: #1e222d; }
        .tape-time { color: #787b86; } .tape-price { font-weight: bold; text-align: right; } .tape-size { text-align: right; color: #d1d4dc; }

        /* TIMEFRAME */
        .tf-morph-container { display: flex; align-items: center; background: rgba(42, 46, 57, 0.9); border: 1px solid #444; border-radius: 3px; height: 24px; overflow: hidden; transition: all 0.2s ease-out; position: relative; }
        .tf-single { padding: 0 6px; font-size: 11px; font-weight: bold; color: #d1d4dc; cursor: pointer; line-height: 20px; min-width: 25px; text-align: center; display: block; }
        .tf-options-row { display: none; flex-direction: row; }
        .tf-morph-container.expanded { position: absolute; z-index: 100; width: auto; top: 0; left: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .tf-morph-container.expanded .tf-single { display: none; }
        .tf-morph-container.expanded .tf-options-row { display: flex; }
        .tf-btn { border-right: 1px solid #444; padding: 0 8px; cursor: pointer; color: #d1d4dc; font-size: 11px; line-height: 22px; font-weight: bold; background: #1e222d; white-space: nowrap; }
        .tf-btn:hover, .tf-btn.active { background: #2962ff; color: white; }

        /* LINKS */
        .link-blue { background-color: #2962ff; border-color: #2962ff; color: white; }
        .link-orange { background-color: #ff9800; border-color: #ff9800; color: white; }
        .link-green { background-color: #00c853; border-color: #00c853; color: white; }
        .link-purple { background-color: #aa00ff; border-color: #aa00ff; color: white; }
        .link-red { background-color: #d50000; border-color: #d50000; color: white; }

        /* UTILS */
        .t-up { color: var(--up-color); } .t-down { color: var(--down-color); } .t-large { background-color: rgba(41, 98, 255, 0.15); }
        .color-up { color: var(--up-color); } .color-down { color: var(--down-color); }
        .dropdown { position: relative; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; background: var(--panel-color); border: 1px solid var(--border-color); z-index: 5000; display: none; min-width: 160px; border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.8); }
        .dropdown.open .dropdown-menu { display: block; }
        .dropdown-item { padding: 8px 12px; color: #d1d4dc; cursor: pointer; font-size: 13px; border-bottom: 1px solid #2a2e39; }
        .dropdown-item:hover { background: #2a2e39; }
        .dropdown-header { padding: 4px 12px; font-size: 10px; color: #2962ff; font-weight: bold; background: #15181f; }
        
        .icon-btn { background: none; border: none; color: #787b86; cursor: pointer; font-size: 14px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .icon-btn:hover { color: var(--text-color); background: #2a2e39; }
        .icon-btn.active { color: var(--accent-color); background: rgba(41, 98, 255, 0.1); }
        
        #screen-logger { position: absolute; right: 290px; top: 80px; bottom: 0; width: 300px; background: rgba(0,0,0,0.9); border-left: 1px solid #444; font-family: monospace; font-size: 11px; color: #0f0; padding: 10px; overflow-y: auto; z-index: 9999; display: none; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; } .log-err { color: #f55; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 6000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel-color); padding: 20px; border-radius: 6px; width: 400px; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .form-group { margin-bottom: 15px; } .form-label { display: block; font-size: 12px; color: #787b86; margin-bottom: 5px; }
        .form-input { width: 100%; background: #131722; border: 1px solid #2a2e39; color: #fff; padding: 8px; border-radius: 4px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-p { background: var(--accent-color); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-s { background: transparent; color: #d1d4dc; border: 1px solid #444; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
        .btn-danger { background: #d50000; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: auto; }
    </style>
</head>
<body>

<button id="emergency-btn" onclick="nuclearReset()">EMERGENCY DB RESET</button>

<div class="app-container">
    <div class="toolbar">
        <div class="left-controls">
            <a href="./portfolio.html" class="brand"><i class="fas fa-chart-line"></i></a>
            <button class="icon-btn" id="leftToggle" title="Left Sidebar"><i class="fas fa-columns"></i></button>
        </div>
        <div class="ticker-container" id="tickerContainer">
            <div class="ticker-track" id="tickerTrack"><span style="font-size:11px; color:#666;">Loading Market Data...</span></div>
        </div>
        <div class="right-controls">
            <button class="icon-btn active" id="rightToggle" title="Right Sidebar"><i class="fas fa-columns"></i></button>
            <div class="dropdown" id="layoutDropdown">
                <button class="icon-btn" title="Layouts"><i class="fas fa-th-large"></i></button>
                <div class="dropdown-menu">
                    <div class="dropdown-header">MAIN WORKSPACE</div>
                    <div class="dropdown-item" onclick="setChartLayout('1x1')">Single Chart (1)</div>
                    <div class="dropdown-item" onclick="setChartLayout('2x1')">2 Stacked</div>
                    <div class="dropdown-item" onclick="setChartLayout('1x2')">2 Side-by-Side</div>
                    <div class="dropdown-item" onclick="setChartLayout('2x2')">Quad Grid (4)</div>
                    <div class="dropdown-item" onclick="setChartLayout('3x2')">6 Grid (3x2)</div>
                    <div class="dropdown-item" onclick="setChartLayout('2x3')">6 Grid (2x3)</div>
                    <div class="dropdown-item" onclick="setChartLayout('3x3')">9 Grid (3x3)</div>
                    <div class="dropdown-header">LEFT SIDEBAR</div>
                    <div class="dropdown-item" onclick="setLeftSidebarLayout(0)">Hidden</div>
                    <div class="dropdown-item" onclick="setLeftSidebarLayout(1)">1 Widget</div>
                    <div class="dropdown-item" onclick="setLeftSidebarLayout(2)">2 Widgets</div>
                    <div class="dropdown-item" onclick="setLeftSidebarLayout(3)">3 Widgets</div>
                    <div class="dropdown-header">RIGHT SIDEBAR</div>
                    <div class="dropdown-item" onclick="setRightSidebarLayout(0)">Hidden</div>
                    <div class="dropdown-item" onclick="setRightSidebarLayout(1)">1 Widget</div>
                    <div class="dropdown-item" onclick="setRightSidebarLayout(2)">2 Widgets</div>
                    <div class="dropdown-item" onclick="setRightSidebarLayout(3)">3 Widgets</div>
                </div>
            </div>
            <button class="icon-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
            <button class="icon-btn" id="debugToggle"><i class="fas fa-bug"></i></button>
            <button class="icon-btn" id="settingsBtn"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div class="news-strip">
        <div class="news-label">NEWS</div>
        <div class="news-track" id="newsTrack"><span style="color:#666;">Waiting for headlines...</span></div>
    </div>

    <div class="workspace">
        <div id="left-sidebar-area" class="sidebar collapsed"></div>
        <div id="main-area"></div>
        <div id="right-sidebar-area" class="sidebar"></div>
    </div>

    <div id="screen-logger">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><strong>System Logs</strong><button id="clearLogs">Clear</button></div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0; color:#d1d4dc;">API Configuration</h3>
        <div class="form-group"><label class="form-label">Alpaca API Key ID</label><input type="text" id="inpApiKey" class="form-input"></div>
        <div class="form-group"><label class="form-label">Alpaca Secret Key</label><input type="password" id="inpApiSecret" class="form-input"></div>
        <div class="form-group"><label class="form-label">Finnhub API Key</label><input type="password" id="inpFinnhubKey" class="form-input" placeholder="Optional (60 req/min limit)"></div>
        <div class="modal-actions">
            <button class="btn-danger" onclick="nuclearReset()">Factory Reset</button>
            <button class="btn-s" onclick="toggleSettings(false)">Cancel</button>
            <button class="btn-p" onclick="saveApiSettings()">Save & Reload</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="shared.js"></script>

<script>
    const logger = document.getElementById('screen-logger');
    function log(msg, type='info') {
        const div = document.createElement('div'); div.className = 'log-line ' + (type === 'error' ? 'log-err' : '');
        div.innerText = `> ${msg}`; logger.appendChild(div); logger.scrollTop = logger.scrollHeight;
    }
    function formatNum(num) { if(!num) return '0'; if(num>=1e6) return (num/1e6).toFixed(2)+'M'; if(num>=1e3) return (num/1e3).toFixed(1)+'k'; return Math.floor(num).toString(); }

    const LAYOUT_VERSION = 28; // FORCE RESET FOR SAFETY
    const state = {
        layoutVersion: LAYOUT_VERSION,
        isLeftOpen: false, isRightOpen: true,
        layoutMode: '1x1',
        chartsConfig: [{ id: 'm0', type: 'chart', ticker: 'AAPL', timeframe: '5Min', linkGroup: 'A' }],
        leftWidgetsConfig: [], 
        rightWidgetsConfig: [{ id: 'w-right-0', type: 'tape', ticker: 'AAPL', linkGroup: 'A' }],
        activeWidgets: [], 
        refreshInterval: null, screenerInterval: null, tapeInterval: null, newsInterval: null,
        portfolioTickers: [], tapeData: { portfolio: '', gainers: '', losers: '', activeVol: '', activeTrd: '', fallback: '' },
        newsSymbols: new Set()
    };

    // --- GLOBAL ACTIONS (ATTACHED TO WINDOW) ---
    window.nuclearReset = function() {
        if(confirm("NUKE DATABASE? This will clear all settings and reload.")) {
            const req = indexedDB.deleteDatabase("ProfitLadderDB");
            req.onsuccess = () => window.location.reload();
            req.onerror = () => alert("Failed to delete DB. Please clear browser data manually.");
        }
    };

    window.switchWidgetType = function(id) { const cfg = findConfig(id); if(cfg) { cfg.type = (cfg.type === 'chart') ? 'tape' : 'chart'; if(cfg.type === 'chart' && !cfg.timeframe) cfg.timeframe = '5Min'; saveState(); renderAll(); } };
    window.cycleLink = function(id) { const groups = [null, 'A', 'B', 'C', 'D', 'E']; const cfg = findConfig(id); if(cfg) { cfg.linkGroup = groups[(groups.indexOf(cfg.linkGroup) + 1) % groups.length]; saveState(); renderAll(); } };
    window.updateWidgetTicker = function(id, input, e) { if(e.key === 'Enter') { const cfg = findConfig(id); if(cfg) { const val = input.value.toUpperCase(); cfg.ticker = val; syncLinkedWidgets(cfg.linkGroup, val); saveState(); renderAll(); input.blur(); } } };
    window.setWidgetTf = function(id, val, e) { e.stopPropagation(); const cfg = findConfig(id); if(cfg) { cfg.timeframe = val; saveState(); renderAll(); } };
    window.toggleTfMorph = function(id, e) { e.stopPropagation(); document.querySelectorAll('.tf-morph-container').forEach(el => el.classList.remove('expanded')); const el = document.getElementById(`tf-morph-${id}`); if(el) el.classList.add('expanded'); };
    window.setChartLayout = function(mode) { state.layoutMode = mode; const [r, c] = mode.split('x').map(Number); const total = r * c; if(total > state.chartsConfig.length) { for(let i=state.chartsConfig.length; i<total; i++) state.chartsConfig.push({ id: `m${i}`, type: 'chart', ticker: 'AAPL', timeframe: '5Min', linkGroup: null }); } else { state.chartsConfig = state.chartsConfig.slice(0, total); } saveState(); renderAll(); };
    window.setLeftSidebarLayout = function(n) { updateSidebarConfig('left', n); };
    window.setRightSidebarLayout = function(n) { updateSidebarConfig('right', n); };

    // --- HELPERS ---
    function findConfig(id) { return state.chartsConfig.find(x=>x.id===id) || state.leftWidgetsConfig.find(x=>x.id===id) || state.rightWidgetsConfig.find(x=>x.id===id); }
    function syncLinkedWidgets(group, ticker) { if(!group) return; [...state.chartsConfig, ...state.leftWidgetsConfig, ...state.rightWidgetsConfig].forEach(c => { if(c.linkGroup === group) c.ticker = ticker; }); }
    function updateSidebarConfig(side, count) { const arr = (side==='left') ? state.leftWidgetsConfig : state.rightWidgetsConfig; const prefix = (side==='left') ? 'l' : 'r'; if(count === 0) { if(side==='left') state.leftWidgetsConfig=[]; else state.rightWidgetsConfig=[]; if(side==='left') state.isLeftOpen=false; else state.isRightOpen=false; } else { if(count > arr.length) { for(let i=arr.length; i<count; i++) arr.push({ id: `${prefix}${i}`, type: 'tape', ticker: 'AAPL', linkGroup: null }); } else if(count < arr.length) { if(side==='left') state.leftWidgetsConfig = arr.slice(0,count); else state.rightWidgetsConfig = arr.slice(0,count); } if(side==='left') state.isLeftOpen = true; else state.isRightOpen = true; } saveState(); renderAll(); }

    // --- DB ---
    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open("ProfitLadderDB", 4);
            req.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains("Settings")) db.createObjectStore("Settings", { keyPath: "key" });
                if (!db.objectStoreNames.contains("Positions")) db.createObjectStore("Positions", { keyPath: "symbol" });
                if (!db.objectStoreNames.contains("Financials")) db.createObjectStore("Financials", { keyPath: "symbol" });
            };
            req.onsuccess = (event) => resolve(event.target.result);
            req.onerror = (event) => {
                // Force show reset button if DB is broken
                document.getElementById('emergency-btn').style.display = 'block';
                reject("DB Error");
            };
        });
    }

    async function saveState() { try { const db = await openDB(); const tx = db.transaction("Settings", "readwrite"); const s = tx.objectStore("Settings"); s.put({ key: "layoutConfig", value: JSON.stringify({ m: state.chartsConfig, l: state.leftWidgetsConfig, r: state.rightWidgetsConfig, lm: state.layoutMode, lo: state.isLeftOpen, ro: state.isRightOpen, ver: state.layoutVersion }) }); } catch(e) { } }
    async function loadSavedState() { try { const db = await openDB(); const tx = db.transaction("Settings", "readonly"); const req = tx.objectStore("Settings").get("layoutConfig"); await new Promise(r => { req.onsuccess = () => { if(req.result) { const d = JSON.parse(req.result.value); if(d.ver !== LAYOUT_VERSION) return r(); state.chartsConfig = d.m || state.chartsConfig; state.leftWidgetsConfig = d.l || state.leftWidgetsConfig; state.rightWidgetsConfig = d.r || state.rightWidgetsConfig; state.layoutMode = d.lm || '1x1'; state.isLeftOpen = d.lo; state.isRightOpen = d.ro; } r(); }; req.onerror = r; }); } catch(e) { } }
    async function resetLayout(c=true) { if(!c || confirm("Reset Layout?")) { state.chartsConfig = [{ id: 'm0', type: 'chart', ticker: 'AAPL', timeframe: '5Min', linkGroup: 'A' }]; state.leftWidgetsConfig = []; state.rightWidgetsConfig = [{ id: 'w-right-0', type: 'tape', ticker: 'AAPL', linkGroup: 'A' }]; state.layoutMode = '1x1'; state.layoutVersion = LAYOUT_VERSION; state.isLeftOpen = false; state.isRightOpen = true; await saveState(); window.location.reload(); } }
    function toggleSettings(show) { document.getElementById('settingsModal').style.display = show ? 'flex' : 'none'; if(show) { (async () => { const db = await openDB(); const tx = db.transaction("Settings","readonly"); const store = tx.objectStore("Settings"); const getVal = (k) => new Promise(r => { const req = store.get(k); req.onsuccess = () => r(req.result ? req.result.value : ''); }); const [k, s, f] = await Promise.all([getVal("APCA_API_KEY_ID"), getVal("APCA_API_SECRET_KEY"), getVal("FINNHUB_API_KEY")]); document.getElementById('inpApiKey').value = k; document.getElementById('inpApiSecret').value = s; document.getElementById('inpFinnhubKey').value = f; })(); } }
    async function saveApiSettings() { const k = document.getElementById('inpApiKey').value.trim(); const s = document.getElementById('inpApiSecret').value.trim(); const f = document.getElementById('inpFinnhubKey').value.trim(); if(!k||!s) return alert("Alpaca keys required"); try{ const db=await openDB(); const tx=db.transaction("Settings","readwrite"); const store=tx.objectStore("Settings"); store.put({key:"APCA_API_KEY_ID",value:k}); store.put({key:"APCA_API_SECRET_KEY",value:s}); store.put({key:"FINNHUB_API_KEY",value:f}); tx.oncomplete=()=>{alert("Saved");window.location.reload();}; }catch(e){alert("Error: "+e.message);} }

    // --- INIT ---
    async function init() {
        log("Initializing...");
        try {
            await loadSavedState();
            if(state.layoutVersion !== LAYOUT_VERSION) await resetLayout(false);

            renderAll();
            refreshPortfolioTape(); refreshScreenerTape(); refreshNewsTape();
            
            clearInterval(state.refreshInterval); clearInterval(state.screenerInterval); clearInterval(state.tapeInterval);
            state.refreshInterval = setInterval(() => { updateChartsRealtime(); refreshPortfolioTape(); }, 3000);
            state.screenerInterval = setInterval(refreshScreenerTape, 60000);
            state.tapeInterval = setInterval(updateTapeIndividual, 1000);
            state.newsInterval = setInterval(refreshNewsTape, 120000);

            document.getElementById('layoutDropdown').addEventListener('click', e => { e.currentTarget.classList.toggle('open'); e.stopPropagation(); });
            document.addEventListener('click', () => { document.getElementById('layoutDropdown').classList.remove('open'); document.querySelectorAll('.tf-morph-container').forEach(el => el.classList.remove('expanded')); });
            document.getElementById('leftToggle').addEventListener('click', () => toggleSidebar('left'));
            document.getElementById('rightToggle').addEventListener('click', () => toggleSidebar('right'));
            
        } catch(e) {
            console.error(e);
            document.getElementById('emergency-btn').style.display = 'block'; // Show reset if crash
        }
    }

    // --- RENDERERS ---
    function renderAll() {
        state.activeWidgets = [];
        const main = document.getElementById('main-area'); main.innerHTML = '';
        const [r, c] = state.layoutMode.split('x').map(Number);
        main.style.gridTemplateRows = `repeat(${r}, 1fr)`;
        main.style.gridTemplateColumns = `repeat(${c}, 1fr)`;
        state.chartsConfig.forEach(cfg => { const div = document.createElement('div'); div.className = 'chart-slot'; main.appendChild(div); initWidget(div, cfg); });
        renderSidebar('left-sidebar-area', state.leftWidgetsConfig);
        renderSidebar('right-sidebar-area', state.rightWidgetsConfig);
        updateSidebarVisibility();
    }

    function renderSidebar(domId, configArr) {
        const container = document.getElementById(domId); container.innerHTML = '';
        configArr.forEach(cfg => { const div = document.createElement('div'); div.className = 'widget-box'; container.appendChild(div); initWidget(div, cfg); });
    }

    function initWidget(container, cfg) {
        const linkClass = getLinkClass(cfg.linkGroup);
        const isChart = cfg.type === 'chart';
        const iconClass = isChart ? 'fa-chart-bar' : 'fa-list-ol';
        
        const headerHtml = `
            <div class="widget-header">
                <div class="widget-controls-left">
                    <div class="type-btn" onclick="switchWidgetType('${cfg.id}')" title="Switch Type"><i class="fas ${iconClass}"></i></div>
                    <input type="text" class="mini-input" value="${cfg.ticker}" onkeydown="updateWidgetTicker('${cfg.id}', this, event)">
                    ${isChart ? getTfHtml(cfg.id, cfg.timeframe) : ''}
                    <div class="link-btn ${linkClass}" onclick="cycleLink('${cfg.id}')" title="Link Group"><i class="fas fa-link"></i></div>
                </div>
                ${isChart ? 
                    `<div class="l1-overlay" id="l1-${cfg.id}">
                        <div class="l1-btn l1-bid"><span class="l1-price" id="qb-p-${cfg.id}">0.00</span><span class="l1-size" id="qb-s-${cfg.id}">0</span></div>
                        <div class="l1-center"><span class="last-price" id="ql-${cfg.id}">0.00</span><span class="day-vol" id="qv-${cfg.id}">0</span></div>
                        <div class="l1-btn l1-ask"><span class="l1-price" id="qa-p-${cfg.id}">0.00</span><span class="l1-size" id="qa-s-${cfg.id}">0</span></div>
                    </div>` 
                : ''}
            </div>
        `;
        
        const contentHtml = isChart 
            ? `<div class="widget-content" id="content-${cfg.id}">
                 <div class="chart-legend" id="legend-${cfg.id}"><div class="legend-row" id="lg-${cfg.id}"></div></div>
                 <div id="canvas-${cfg.id}" class="chart-canvas-fill"></div>
               </div>`
            : `<div class="widget-content"><div class="tape-header-row"><span>TIME</span><span>PRICE</span><span>SIZE</span></div><div id="tape-list-${cfg.id}" class="tape-content"></div></div>`;

        container.innerHTML = headerHtml + contentHtml;
        if(isChart) initChart(cfg); else initTape(cfg);
    }

    function getTfHtml(id, tf) {
        const mapTF = { '1Min':'1m', '5Min':'5m', '15Min':'15m', '1H':'1H', '4H':'4H', '1D':'1D', '1W':'1W', '1M':'1M' };
        return `
            <div class="tf-morph-container" id="tf-morph-${id}">
                <div class="tf-single" onclick="toggleTfMorph('${id}', event)">${mapTF[tf] || tf}</div>
                <div class="tf-options-row">
                    <div class="tf-btn" onclick="setWidgetTf('${id}', '1Min', event)">1m</div>
                    <div class="tf-btn" onclick="setWidgetTf('${id}', '5Min', event)">5m</div>
                    <div class="tf-btn" onclick="setWidgetTf('${id}', '15Min', event)">15m</div>
                    <div class="tf-btn" onclick="setWidgetTf('${id}', '1H', event)">1H</div>
                    <div class="tf-btn" onclick="setWidgetTf('${id}', '4H', event)">4H</div>
                    <div class="tf-btn" onclick="setWidgetTf('${id}', '1D', event)">D</div>
                    <div class="tf-btn" onclick="setWidgetTf('${id}', '1W', event)">W</div>
                    <div class="tf-btn" onclick="setWidgetTf('${id}', '1M', event)">M</div>
                </div>
            </div>`;
    }

    // --- DATA LOGIC ---
    async function fetchFinancials(symbol) {
        const db = await openDB();
        const tx = db.transaction(["Settings", "Financials"], "readwrite");
        const cache = await new Promise(r => { const req = tx.objectStore("Financials").get(symbol); req.onsuccess = () => r(req.result); req.onerror = () => r(null); });
        const now = Date.now();
        if (cache && (now - cache.timestamp < 86400000)) return cache.data;

        const key = await new Promise(r => { const req = tx.objectStore("Settings").get("FINNHUB_API_KEY"); req.onsuccess = () => r(req.result ? req.result.value : null); });
        if (!key) return null;

        try {
            const url = `https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${key}`;
            const res = await fetch(url);
            if (!res.ok) return null;
            const data = await res.json();
            const store = db.transaction("Financials", "readwrite").objectStore("Financials");
            store.put({ symbol: symbol, data: data, timestamp: now });
            return data;
        } catch (e) { return null; }
    }

    async function initChart(cfg) {
        const container = document.getElementById(`canvas-${cfg.id}`);
        await new Promise(r => setTimeout(r, 50)); 
        const chart = LightweightCharts.createChart(container, {
            layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
            timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#2a2e39', minBarSpacing: 0.005 },
            crosshair: { mode: 0 },
            rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.25 } },
        });
        const volSeries = chart.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: 'vol' });
        chart.priceScale('vol').applyOptions({ scaleMargins: { top: 0.75, bottom: 0 } });
        const candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350' });
        
        const wrapper = document.getElementById(`content-${cfg.id}`);
        new ResizeObserver(e => { 
            if (e.length && e[0].contentRect) {
                chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height }); 
            }
        }).observe(wrapper);
        setTimeout(() => { if(wrapper.clientWidth > 0) chart.applyOptions({ width: wrapper.clientWidth, height: wrapper.clientHeight }); }, 200);

        const obj = { ...cfg, chart, candleSeries, volSeries, lastPrice: 0, earliestTime: null, isLoading: false };
        state.activeWidgets.push(obj);
        chart.subscribeCrosshairMove(p => {
            const c = p.seriesData.get(candleSeries); const v = p.seriesData.get(volSeries);
            if (c) document.getElementById(`lg-${cfg.id}`).innerHTML = `O:${c.open.toFixed(2)} H:${c.high.toFixed(2)} L:${c.low.toFixed(2)} C:<span class="${c.close>=c.open?'color-up':'color-down'}">${c.close.toFixed(2)}</span> ${v?`V:${formatNum(v.value)}`:''}`;
        });
        chart.timeScale().subscribeVisibleLogicalRangeChange(range => { if(range && range.from < 10 && !obj.isLoading) loadOlderData(obj); });
        await loadChartData(obj);
        updateChartsRealtime();
    }

    function initTape(cfg) { 
        const obj = { ...cfg, lastTradeId: 0, lastPrice: 0, tradeHistory: [] };
        state.activeWidgets.push(obj); 
        updateTapeIndividual();
    }

    async function updateTapeIndividual() {
        if(!state.isLeftOpen && !state.isRightOpen && !state.chartsConfig.some(x=>x.type==='tape')) return;
        const k=await getKeys(); if(!k) return;
        const start = new Date(Date.now() - 86400000 * 3).toISOString(); 
        const tapeWidgets = state.activeWidgets.filter(w => w.type === 'tape');
        await Promise.all(tapeWidgets.map(async w => {
            const list = document.getElementById(`tape-list-${w.id}`);
            if(!list || list.offsetParent === null) return;
            const u = `https://data.alpaca.markets/v2/stocks/${w.ticker}/trades?limit=50&sort=desc&feed=sip&start=${start}`;
            try {
                const res = await fetch(u, { headers: { "APCA-API-KEY-ID": k.k, "APCA-API-SECRET-KEY": k.s } });
                if(!res.ok) return;
                const json = await res.json();
                if(json.trades) {
                    const newTrades = json.trades.filter(t => !w.tradeHistory.some(existing => existing.i === t.i));
                    if(newTrades.length === 0) return;
                    w.tradeHistory = [...w.tradeHistory, ...newTrades].sort((a, b) => new Date(b.t) - new Date(a.t));
                    if(w.tradeHistory.length > 50) w.tradeHistory = w.tradeHistory.slice(0, 50);
                    let h = '';
                    for(let i=0; i<w.tradeHistory.length; i++) {
                        const t = w.tradeHistory[i];
                        const prevPrice = (i < w.tradeHistory.length - 1) ? w.tradeHistory[i+1].p : t.p;
                        const c = t.p >= prevPrice ? 't-up' : 't-down';
                        const bg = t.s >= 100 ? 't-large' : '';
                        const tm = new Date(t.t).toLocaleTimeString([],{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
                        h += `<div class="tape-row ${bg}"><span class="tape-time">${tm}</span><span class="tape-price ${c}">${t.p.toFixed(2)}</span><span class="tape-size">${t.s}</span></div>`;
                    }
                    list.innerHTML = h;
                }
            } catch(e) { }
        }));
    }

    async function updateChartsRealtime() {
        const keys = await getKeys(); if(!keys) return;
        const widgets = state.activeWidgets;
        if(widgets.length === 0) return;
        const symbols = [...new Set(widgets.map(w => w.ticker))];
        const u = `https://data.alpaca.markets/v2/stocks/snapshots?symbols=${symbols.join(',')}`;
        try {
            const res = await fetch(u, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } });
            const json = await res.json();
            widgets.forEach(w => {
                const data = json[w.ticker];
                if(!data) return;
                const q = data.latestQuote;
                const t = data.latestTrade;
                const d = data.dailyBar;
                const mb = data.minuteBar;
                const l1 = document.getElementById(`l1-${w.id}`);
                if(l1 && l1.offsetParent !== null && q) {
                    document.getElementById(`qb-p-${w.id}`).innerText = q.bp.toFixed(2);
                    document.getElementById(`qb-s-${w.id}`).innerText = q.bs;
                    document.getElementById(`qa-p-${w.id}`).innerText = q.ap.toFixed(2);
                    document.getElementById(`qa-s-${w.id}`).innerText = q.as;
                    if(t) {
                        const el = document.getElementById(`ql-${w.id}`);
                        el.innerText = t.p.toFixed(2);
                        el.style.color = t.p >= w.lastPrice ? '#26a69a' : '#ef5350';
                    }
                    if(d) document.getElementById(`qv-${w.id}`).innerText = formatNum(d.v);
                }
                if(w.type === 'chart') {
                    if(w.timeframe === '1D' && d) { updateChartBar(w, snapTime(new Date(d.t).getTime()/1000, '1D'), d.o, d.h, d.l, d.c, d.v); }
                    else if(w.timeframe && w.timeframe.includes('Min') && mb) { updateChartBar(w, snapTime(new Date(mb.t).getTime()/1000, w.timeframe), mb.o, mb.h, mb.l, mb.c, mb.v); }
                }
            });
        } catch(e) {}
    }

    function updateChartBar(c,t,o,h,l,cl,v){c.candleSeries.update({time:t,open:o,high:h,low:l,close:cl});c.volSeries.update({time:t,value:v,color:(cl>=o?'#26a69a':'#ef5350')});}
    async function loadChartData(c) { const keys = await getKeys(); if(!keys) return; 
        fetchFinancials(c.ticker); // BACKGROUND FINNHUB
        const end = new Date().toISOString(); const start = "2020-01-01T00:00:00Z"; 
        let tf = c.timeframe; if(tf==='4H') tf='4Hour'; if(tf==='1W') tf='1Week'; if(tf==='1M') tf='1Month'; if(tf==='1H') tf='1Hour';
        const url = `https://data.alpaca.markets/v2/stocks/${c.ticker}/bars?timeframe=${tf}&start=${start}&end=${end}&limit=10000&adjustment=split&sort=desc`; try { const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); const json = await res.json(); if(json.bars) { const data = parseBars(json.bars.reverse()); c.candleSeries.setData(data.ohlc); c.volSeries.setData(data.vol); const len=data.ohlc.length; if(len>100) c.chart.timeScale().setVisibleLogicalRange({from:len-100,to:len}); else c.chart.timeScale().fitContent(); c.lastPrice = data.ohlc[len-1].close; c.earliestTime = data.ohlc[0].time; } } catch(e) { log(`Err loading ${c.ticker}: ${e.message}`); } }
    async function loadOlderData(c) { if(!c.earliestTime || c.isLoading) return; c.isLoading = true; const keys = await getKeys(); const visibleBars = Math.ceil(c.chart.timeScale().getVisibleLogicalRange().to - c.chart.timeScale().getVisibleLogicalRange().from); const limit = Math.min(Math.max(visibleBars*2, 500), 10000); const endStr = new Date((c.earliestTime - 1) * 1000).toISOString(); 
        let tf = c.timeframe; if(tf==='4H') tf='4Hour'; if(tf==='1W') tf='1Week'; if(tf==='1M') tf='1Month'; if(tf==='1H') tf='1Hour';
        const url = `https://data.alpaca.markets/v2/stocks/${c.ticker}/bars?timeframe=${tf}&start=2015-01-01T00:00:00Z&end=${endStr}&limit=${limit}&sort=desc&adjustment=split`; try { const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); const json = await res.json(); if(json.bars) { const data = parseBars(json.bars.reverse()); c.candleSeries.setData([...data.ohlc, ...c.candleSeries.data()]); c.volSeries.setData([...data.vol, ...c.volSeries.data()]); c.earliestTime = data.ohlc[0].time; } } catch(e) {} finally { c.isLoading = false; } }
    function updateSidebarVisibility() { const l=document.getElementById('left-sidebar-area'), r=document.getElementById('right-sidebar-area'), bl=document.getElementById('leftToggle'), br=document.getElementById('rightToggle'); if(state.isLeftOpen){l.classList.remove('collapsed');bl.classList.add('active');}else{l.classList.add('collapsed');bl.classList.remove('active');} if(state.isRightOpen){r.classList.remove('collapsed');br.classList.add('active');}else{r.classList.add('collapsed');br.classList.remove('active');} setTimeout(() => { state.activeWidgets.forEach(w => { if(w.type==='chart') w.chart.applyOptions({ width: document.getElementById(`content-${w.id}`).clientWidth }); }); }, 300); }
    function snapTime(t,f){if(f==='1Min')return Math.floor(t/60)*60;if(f==='5Min')return Math.floor(t/300)*300;if(f==='15Min')return Math.floor(t/900)*900;if(f==='1H')return Math.floor(t/3600)*3600;return t;}
    function parseBars(b){const o=[],v=[];b.forEach(x=>{const t=new Date(x.t).getTime()/1000;o.push({time:t,open:x.o,high:x.h,low:x.l,close:x.c});v.push({time:t,value:x.v,color:(x.c>=x.o?'#26a69a':'#ef5350')});});return{ohlc:o,vol:v};}
    async function getKeys() { if(typeof getApiKeys!=='function') return null; const k=await getApiKeys(); return (k.alpacaKey||k.k) ? {k:k.alpacaKey||k.k, s:k.alpacaSecret||k.s} : null; }
    function getLinkClass(g){if(g==='A')return'link-blue';if(g==='B')return'link-orange';if(g==='C')return'link-green';if(g==='D')return'link-purple';if(g==='E')return'link-red';return'';}
    async function refreshPortfolioTape(){const k=await getKeys();if(!k)return;try{const db=await new Promise((r,j)=>{const q=indexedDB.open("ProfitLadderDB",4);q.onsuccess=e=>r(e.target.result);q.onerror=j;});const tx=db.transaction("Positions","readonly");const p=await new Promise(r=>{tx.objectStore("Positions").getAll().onsuccess=e=>r(e.target.result);});const t=p.map(x=>x.tickerSymbol);t.forEach(s=>state.newsSymbols.add(s));if(t.length){const r=await fetch(`https://data.alpaca.markets/v2/stocks/snapshots?symbols=${t.join(',')}`,{headers:{"APCA-API-KEY-ID":k.k,"APCA-API-SECRET-KEY":k.s}});if(r.ok){const j=await r.json();const i=Object.entries(j).map(([s,d])=>parseSnapshot(d,s));state.tapeData.portfolio=generateSectionHTML("PORTFOLIO",i);renderTape();}}}catch(e){}}
    async function refreshScreenerTape(){const k=await getKeys();if(!k)return;fetchScreener(k,'movers?top=10','gainers',"TOP GAINERS").then(h=>{state.tapeData.gainers=h;renderTape();});fetchScreener(k,'movers?top=10','losers',"TOP LOSERS").then(h=>{state.tapeData.losers=h;renderTape();});fetchActives(k,'volume','activeVol',"ACTIVE (VOL)");fetchActives(k,'trades','activeTrd',"ACTIVE (TRD)");if(!state.tapeData.activeVol)fetchFallbackIndices(k);}
    async function fetchScreener(k,e,n,t){try{const r=await fetch(`https://data.alpaca.markets/v1beta1/screener/stocks/${e}`,{headers:{"APCA-API-KEY-ID":k.k,"APCA-API-SECRET-KEY":k.s}});if(!r.ok)return'';const j=await r.json();const i=(j[n]||[]).map(x=>({symbol:x.symbol,price:x.price,pct:x.percent_change}));i.forEach(x=>state.newsSymbols.add(x.symbol));return generateSectionHTML(t,i);}catch(e){return'';}}
    async function fetchActives(k,b,sk,t){try{const r=await fetch(`https://data.alpaca.markets/v1beta1/screener/stocks/most-actives?by=${b}&top=10`,{headers:{"APCA-API-KEY-ID":k.k,"APCA-API-SECRET-KEY":k.s}});if(!r.ok)return;const j=await r.json();const l=j.most_actives||[];const s=l.map(i=>i.symbol);s.forEach(sym=>state.newsSymbols.add(sym));if(!s.length)return;const sr=await fetch(`https://data.alpaca.markets/v2/stocks/snapshots?symbols=${s.join(',')}`,{headers:{"APCA-API-KEY-ID":k.k,"APCA-API-SECRET-KEY":k.s}});if(sr.ok){const sj=await sr.json();const i=Object.entries(sj).map(([sy,d])=>parseSnapshot(d,sy));state.tapeData[sk]=generateSectionHTML(t,i);renderTape();}}catch(e){}}
    async function fetchFallbackIndices(k){try{const r=await fetch(`https://data.alpaca.markets/v2/stocks/snapshots?symbols=SPY,QQQ,IWM,DIA`,{headers:{"APCA-API-KEY-ID":k.k,"APCA-API-SECRET-KEY":k.s}});if(r.ok){const j=await r.json();const i=Object.entries(j).map(([s,d])=>parseSnapshot(d,s));state.tapeData.fallback=generateSectionHTML("INDICES",i);renderTape();}}catch(e){} }
    async function refreshNewsTape(){const k=await getKeys();if(!k)return;let s=Array.from(state.newsSymbols);if(!s.length)s=['SPY','QQQ'];const r=s.slice(0,25).join(',');const u=`https://data.alpaca.markets/v1beta1/news?symbols=${r}&limit=50`;try{const rs=await fetch(u,{headers:{"APCA-API-KEY-ID":k.k,"APCA-API-SECRET-KEY":k.s}});if(!rs.ok)return;const j=await rs.json();if(j.news){let h='';j.news.forEach(n=>{const sym=(n.symbols&&n.symbols.length)?n.symbols[0]:'MKT';const t=new Date(n.updated_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});h+=`<a class="news-item" href="${n.url}" target="_blank"><span class="news-sym">${sym}</span><span>${n.headline}</span><span class="news-time">${t}</span></a>`;});document.getElementById('newsTrack').innerHTML=h+h;}}catch(e){}}
    function renderTape() { const t=document.getElementById('tickerTrack'); let h=[state.tapeData.portfolio,state.tapeData.gainers,state.tapeData.losers,state.tapeData.activeVol,state.tapeData.activeTrd,state.tapeData.fallback].join(''); if(h.trim().length===0) h='<span style="color:#666;">Loading...</span>'; t.innerHTML=h+h; }
    function parseSnapshot(d,s) { if(!d||!d.latestTrade)return null; const p=d.latestTrade.p; const pr=d.prevDailyBar?d.prevDailyBar.c:p; return{symbol:s,price:p,pct:((p-pr)/pr)*100}; }
    function generateSectionHTML(t,i) { if(!i||i.length===0)return ''; let h=`<div class="ticker-section"><span class="section-label">${t}</span>`; i.forEach(x=>{ if(!x)return; const c=x.pct>=0?'color-up':'color-down'; const ic=x.pct>=0?'▲':'▼'; h+=`<div class="ticker-item" onclick="changeTicker('${x.symbol}')"><span class="t-sym">${x.symbol}</span><span class="t-price">${x.price.toFixed(2)}</span><span class="t-chg ${c}">${ic} ${Math.abs(x.pct).toFixed(2)}%</span></div>`; }); return h+'</div>'; }

    document.addEventListener('DOMContentLoaded', init);
    document.getElementById('debugToggle').addEventListener('click', () => logger.style.display = logger.style.display === 'block' ? 'none' : 'block');
    document.getElementById('refreshBtn').addEventListener('click', () => state.activeWidgets.forEach(w=>{if(w.type==='chart')loadChartData(w)}));
    document.getElementById('settingsBtn').addEventListener('click', () => toggleSettings(true));
    document.getElementById('clearLogs').addEventListener('click', () => logger.innerHTML = '');
</script>
</body>
</html>
