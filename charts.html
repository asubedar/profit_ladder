<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Charting (Collapsible Tape)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #131722; --panel-color: #1e222d; --border-color: #2a2e39;
            --text-color: #d1d4dc; --accent-color: #2962ff; --up-color: #26a69a; --down-color: #ef5350;
        }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, sans-serif; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* TOOLBAR */
        .toolbar { height: 40px; background-color: var(--panel-color); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 10px; gap: 10px; font-size: 13px; flex-shrink: 0; }
        .brand { font-weight: bold; color: var(--text-color); text-decoration: none; margin-right: 5px; }
        .symbol-search input { background-color: #2a2e39; border: 1px solid #2a2e39; color: white; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; width: 80px; transition: 0.2s; }
        .symbol-search input:focus { border-color: var(--accent-color); outline: none; }
        .intervals { display: flex; background: #131722; border-radius: 4px; padding: 2px; gap: 1px; flex-shrink: 0; }
        .interval-btn { background: none; border: none; color: #787b86; cursor: pointer; padding: 4px 8px; font-size: 12px; border-radius: 3px; }
        .interval-btn:hover { color: var(--text-color); background-color: #2a2e39; }
        .interval-btn.active { color: #fff; background-color: var(--accent-color); }

        /* TICKER TAPE */
        .ticker-container {
            flex-grow: 1; overflow: hidden; white-space: nowrap; position: relative; height: 100%; display: flex; align-items: center;
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        .ticker-track { display: flex; gap: 20px; animation: tickerScroll 90s linear infinite; padding-left: 20px; }
        .ticker-item { display: flex; align-items: center; gap: 6px; font-family: 'Monaco', monospace; font-size: 14px; cursor: pointer; }
        .ticker-item:hover { opacity: 0.8; }
        .t-sym { font-weight: bold; color: #d1d4dc; } .t-price { color: #d1d4dc; } .t-chg { font-weight: bold; }
        @keyframes tickerScroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .section-label { color: #2962ff; font-weight: 900; font-size: 11px; letter-spacing: 1px; border: 1px solid #2962ff; padding: 3px 6px; border-radius: 4px; margin-right: 5px; }
        .ticker-section { display: flex; gap: 20px; align-items: center; }

        /* QUOTE STRIP */
        .quote-strip { height: 30px; background-color: #131722; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 15px; gap: 20px; font-family: 'Monaco', monospace; font-size: 12px; flex-shrink: 0; }
        .q-item { display: flex; gap: 5px; } .q-label { color: #787b86; } .q-val { color: #d1d4dc; font-weight: bold; }

        /* WORKSPACE */
        .workspace { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        
        /* CHART */
        #chart-container { flex-grow: 1; position: relative; height: 100%; transition: width 0.2s; }
        .chart-legend { position: absolute; top: 10px; left: 10px; z-index: 20; font-size: 12px; font-family: monospace; pointer-events: none; }
        .legend-row { display: flex; gap: 15px; margin-bottom: 2px; }
        #history-loader { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: rgba(41, 98, 255, 0.9); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; z-index: 30; display: none; }

        /* TIME & SALES PANEL (Updated CSS) */
        .tape-panel {
            width: 260px; 
            min-width: 260px; /* Ensure it doesn't get squashed */
            background-color: #131722; 
            border-left: 1px solid var(--border-color);
            display: flex; flex-direction: column; flex-shrink: 0;
            transition: all 0.25s ease-in-out; /* Smooth width transition */
            overflow: hidden; /* Hide content when width is 0 */
        }
        
        /* When Collapsed: Width becomes 0 */
        .tape-panel.collapsed { 
            width: 0 !important; 
            min-width: 0 !important; 
            border-left: none;
        }
        
        .tape-header {
            height: 30px; background-color: var(--panel-color); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; padding: 0 10px; gap: 10px;
            white-space: nowrap; /* Prevent text wrap during transition */
        }
        .tape-input {
            background: #2a2e39; border: 1px solid #444; color: #d1d4dc; 
            font-size: 11px; padding: 2px 5px; width: 60px; text-transform: uppercase; font-weight: bold;
            border-radius: 3px;
        }
        .tape-input:focus { border-color: var(--accent-color); outline: none; }

        .tape-list { flex-grow: 1; overflow-y: auto; font-family: 'Monaco', monospace; font-size: 12px; }
        .tape-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 4px 10px; border-bottom: 1px solid #1e222d; cursor: default; }
        .tape-row:hover { background-color: #1e222d; }
        .tape-time { color: #787b86; }
        .tape-price { font-weight: bold; text-align: right; }
        .tape-size { text-align: right; color: #d1d4dc; }
        .t-up { color: var(--up-color); } .t-down { color: var(--down-color); } .t-large { background-color: rgba(41, 98, 255, 0.15); }

        /* UTILS */
        .color-up { color: var(--up-color); } .color-down { color: var(--down-color); }
        #screen-logger { position: absolute; right: 270px; top: 70px; bottom: 0; width: 300px; background: rgba(0,0,0,0.9); border-left: 1px solid #444; font-family: monospace; font-size: 11px; color: #0f0; padding: 10px; overflow-y: auto; z-index: 999; display: none; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #333; } .log-err { color: #f55; }
        .right-controls { margin-left: auto; display: flex; gap: 10px; flex-shrink: 0; background: var(--panel-color); z-index: 2; padding-left: 10px; }
        .icon-btn { background: none; border: none; color: #787b86; cursor: pointer; font-size: 14px; }
        .icon-btn:hover { color: var(--text-color); }
        .icon-btn.active { color: var(--accent-color); }
    </style>
</head>
<body>

<div class="app-container">
    <div class="toolbar">
        <a href="./portfolio.html" class="brand"><i class="fas fa-chart-line"></i></a>
        <div class="symbol-search"><input type="text" id="tickerInput" value="AAPL"></div>
        <div class="intervals">
            <button class="interval-btn" data-tf="1Min">1m</button>
            <button class="interval-btn active" data-tf="5Min">5m</button>
            <button class="interval-btn" data-tf="15Min">15m</button>
            <button class="interval-btn" data-tf="1H">1h</button>
            <button class="interval-btn" data-tf="1D">D</button>
        </div>
        <div class="ticker-container" id="tickerContainer">
            <div class="ticker-track" id="tickerTrack"><span style="font-size:11px; color:#666;">Loading...</span></div>
        </div>
        <div class="right-controls">
            <button class="icon-btn" id="tapeToggle" title="Toggle Time & Sales"><i class="fas fa-list-ol"></i></button>
            <button class="icon-btn" id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
            <button class="icon-btn" id="debugToggle"><i class="fas fa-bug"></i></button>
            <button class="icon-btn" id="settingsBtn"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div class="quote-strip">
        <div class="q-item"><span class="q-label">LAST:</span><span class="q-val" id="q-last">0.00</span></div>
        <div class="q-item"><span class="q-label">BID:</span><span class="q-val" id="q-bid">0.00</span></div>
        <div class="q-item"><span class="q-label">ASK:</span><span class="q-val" id="q-ask">0.00</span></div>
        <div class="q-item" style="margin-left: auto;"><span class="q-label">VOL:</span><span class="q-val" id="q-vol">0</span></div>
    </div>

    <div class="workspace">
        <div id="chart-container">
            <div id="history-loader"><i class="fas fa-circle-notch fa-spin"></i> Loading older data...</div>
            <div class="chart-legend">
                <div id="lg-header" style="font-weight:bold; font-size:1.2em; color: #787b86;">LOADING...</div>
                <div class="legend-row" id="lg-ohlc"></div>
                <div class="legend-row" id="lg-vol"></div>
            </div>
        </div>

        <div class="tape-panel" id="tapePanel">
            <div class="tape-header">
                <span style="font-weight:bold; color:#d1d4dc;">TAPE</span>
                <input type="text" id="tapeInput" class="tape-input" value="AAPL">
            </div>
            <div class="tape-header" style="background: #131722; font-size:10px;">
                <span>TIME</span> <span>PRICE</span> <span>SIZE</span>
            </div>
            <div class="tape-list" id="tapeList"></div>
        </div>
    </div>

    <div id="screen-logger">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><strong>System Logs</strong><button id="clearLogs">Clear</button></div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="shared.js"></script>

<script>
    const logger = document.getElementById('screen-logger');
    function log(msg, type='info') {
        const div = document.createElement('div'); div.className = 'log-line ' + (type === 'error' ? 'log-err' : '');
        div.innerText = `> ${msg}`; logger.appendChild(div); logger.scrollTop = logger.scrollHeight;
    }
    function formatNum(num) {
        if (!num) return '0';
        if (num >= 1000000) return (num/1000000).toFixed(2) + 'M';
        if (num >= 1000) return (num/1000).toFixed(1) + 'k';
        return Math.floor(num).toString();
    }

    const state = {
        ticker: 'AAPL', timeframe: '5Min', chart: null,
        tapeTicker: 'AAPL', isTapeOpen: true,
        series: { candle: null, volume: null },
        refreshInterval: null, screenerInterval: null, tapeInterval: null,
        masterData: [], earliestTime: null,
        isLoadingHistory: false, noMoreHistory: false, lastPrice: 0,
        portfolioTickers: [], screenerTickers: [],
        tapeData: { portfolio: '', gainers: '', losers: '', activeVol: '', activeTrd: '', fallback: '' },
        lastTradeId: 0
    };

    async function init() {
        const el = document.getElementById('chart-container');
        state.chart = LightweightCharts.createChart(el, {
            layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
            timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#2a2e39', minBarSpacing: 0.005 },
            crosshair: { mode: 0 },
            rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.25 } },
        });

        state.series.volume = state.chart.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: 'volume_scale' });
        state.chart.priceScale('volume_scale').applyOptions({ scaleMargins: { top: 0.75, bottom: 0 } });
        state.series.candle = state.chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350' });

        new ResizeObserver(e => { if (e.length && e[0].contentRect) state.chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height }); }).observe(el);
        state.chart.subscribeCrosshairMove(updateLegend);
        state.chart.timeScale().subscribeVisibleLogicalRangeChange(onVisibleLogicalRangeChanged);

        log("Chart initialized.");
        await loadSavedState();
        state.tapeTicker = state.ticker; 
        document.getElementById('tapeInput').value = state.tapeTicker;

        await loadInitialData(); 
        refreshPortfolioTape(); refreshScreenerTape();
        
        if (state.refreshInterval) clearInterval(state.refreshInterval);
        if (state.screenerInterval) clearInterval(state.screenerInterval);
        if (state.tapeInterval) clearInterval(state.tapeInterval);

        state.refreshInterval = setInterval(() => { updateRealtime(); refreshPortfolioTape(); }, 3000);
        state.screenerInterval = setInterval(refreshScreenerTape, 60000);
        state.tapeInterval = setInterval(updateTimeAndSales, 1000);
        
        updateTapeVisibility();
    }

    // --- TAPE UI LOGIC ---
    function toggleTape() {
        state.isTapeOpen = !state.isTapeOpen;
        updateTapeVisibility();
        
        // Restart polling immediately if opened
        if(state.isTapeOpen) {
            updateTimeAndSales();
        }
    }

    function updateTapeVisibility() {
        const panel = document.getElementById('tapePanel');
        const btn = document.getElementById('tapeToggle');
        
        if (state.isTapeOpen) {
            panel.classList.remove('collapsed');
            btn.classList.add('active');
        } else {
            panel.classList.add('collapsed');
            btn.classList.remove('active');
        }
        // Force Chart Resize after transition
        setTimeout(() => {
            const container = document.getElementById('chart-container');
            state.chart.applyOptions({ width: container.clientWidth });
        }, 300); // Wait for CSS transition (0.25s)
    }

    async function updateTimeAndSales() {
        if (!state.isTapeOpen) return; // Save bandwidth
        const keys = await getKeys(); if (!keys) return;
        
        const url = `https://data.alpaca.markets/v2/stocks/${state.tapeTicker}/trades?limit=50&sort=desc&feed=sip`; 
        try {
            const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } });
            if(!res.ok) return;
            const json = await res.json();
            if (json.trades && json.trades.length > 0) {
                const list = document.getElementById('tapeList');
                const rawTrades = json.trades; 
                const newTrades = [];
                for (let t of rawTrades) {
                    if (state.lastTradeId && t.i <= state.lastTradeId) break;
                    newTrades.push(t);
                }
                if (newTrades.length === 0) return; 
                state.lastTradeId = newTrades[0].i;
                let htmlRows = '';
                for (let t of newTrades) {
                    let colorClass = 't-neutral';
                    if (t.p > state.lastPrice) colorClass = 't-up'; else if (t.p < state.lastPrice) colorClass = 't-down'; else colorClass = 'tape-time'; 
                    state.lastPrice = t.p; 
                    let rowClass = 'tape-row'; if (t.s >= 100) rowClass += ' t-large';
                    const timeStr = new Date(t.t).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    htmlRows += `<div class="${rowClass}"><span class="tape-time">${timeStr}</span><span class="tape-price ${colorClass}">${t.p.toFixed(2)}</span><span class="tape-size">${t.s}</span></div>`;
                }
                list.insertAdjacentHTML('afterbegin', htmlRows);
                while(list.children.length > 50) list.removeChild(list.lastChild);
            }
        } catch(e) { }
    }

    // --- DATA & CHARTING ---
    async function refreshPortfolioTape() { const keys = await getKeys(); if(!keys) return; try { const db = await new Promise((r, j) => { const req = indexedDB.open("ProfitLadderDB", 3); req.onsuccess = e=>r(e.target.result); req.onerror = j; }); const tx = db.transaction("Positions", "readonly"); const positions = await new Promise(r => { tx.objectStore("Positions").getAll().onsuccess = e => r(e.target.result); }); const tickers = positions.map(p => p.tickerSymbol); if (tickers.length > 0) { const res = await fetch(`https://data.alpaca.markets/v2/stocks/snapshots?symbols=${tickers.join(',')}`, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); if(res.ok) { const json = await res.json(); const items = Object.entries(json).map(([sym, d]) => parseSnapshot(d, sym)); state.tapeData.portfolio = generateSectionHTML("PORTFOLIO", items); renderTape(); } } else { state.tapeData.portfolio = '<span class="section-label" style="border-color:#444; color:#666;">PORTFOLIO EMPTY</span>'; renderTape(); } } catch(e) { } }
    async function refreshScreenerTape() { const keys = await getKeys(); if(!keys) return; fetchScreener(keys, 'movers?top=10', 'gainers', "TOP GAINERS").then(html => { state.tapeData.gainers = html; renderTape(); }); fetchScreener(keys, 'movers?top=10', 'losers', "TOP LOSERS").then(html => { state.tapeData.losers = html; renderTape(); }); fetchActives(keys, 'volume', 'activeVol', "MOST ACTIVE (VOL)"); fetchActives(keys, 'trades', 'activeTrd', "MOST ACTIVE (TRDS)"); if (!state.tapeData.activeVol && !state.tapeData.gainers) fetchFallbackIndices(keys); }
    async function fetchScreener(keys, endpoint, keyName, title) { try { const res = await fetch(`https://data.alpaca.markets/v1beta1/screener/stocks/${endpoint}`, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); if(!res.ok) return ''; const json = await res.json(); const items = (json[keyName] || []).map(item => ({ symbol: item.symbol, price: item.price, pct: item.percent_change })); return generateSectionHTML(title, items); } catch(e) { return ''; } }
    async function fetchActives(keys, by, stateKey, title) { try { const res = await fetch(`https://data.alpaca.markets/v1beta1/screener/stocks/most-actives?by=${by}&top=10`, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); if(!res.ok) return; const json = await res.json(); const list = json.most_actives || []; const symbols = list.map(i => i.symbol); if (symbols.length === 0) return; const snapRes = await fetch(`https://data.alpaca.markets/v2/stocks/snapshots?symbols=${symbols.join(',')}`, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); if(snapRes.ok) { const snapJson = await snapRes.json(); const items = Object.entries(snapJson).map(([sym, d]) => parseSnapshot(d, sym)); state.tapeData[stateKey] = generateSectionHTML(title, items); renderTape(); } } catch(e) { } }
    async function fetchFallbackIndices(keys) { try { const res = await fetch(`https://data.alpaca.markets/v2/stocks/snapshots?symbols=SPY,QQQ,IWM,DIA`, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); if(res.ok) { const json = await res.json(); const items = Object.entries(json).map(([sym, d]) => parseSnapshot(d, sym)); state.tapeData.fallback = generateSectionHTML("INDICES (FALLBACK)", items); renderTape(); } } catch(e) {} }
    function renderTape() { const track = document.getElementById('tickerTrack'); let fullHtml = [ state.tapeData.portfolio, state.tapeData.gainers, state.tapeData.losers, state.tapeData.activeVol, state.tapeData.activeTrd, state.tapeData.fallback ].join(''); if (fullHtml.trim().length === 0) fullHtml = '<span style="color:#666; font-size:11px;">Loading Data...</span>'; track.innerHTML = fullHtml + fullHtml; }
    function parseSnapshot(data, symbol) { if(!data || !data.latestTrade) return null; const price = data.latestTrade.p; const prev = (data.prevDailyBar) ? data.prevDailyBar.c : price; return { symbol: symbol, price: price, pct: ((price - prev) / prev) * 100 }; }
    function generateSectionHTML(title, items) { if (!items || items.length === 0) return ''; let html = `<div class="ticker-section"><span class="section-label">${title}</span>`; items.forEach(item => { if(!item) return; const colorClass = item.pct >= 0 ? 'color-up' : 'color-down'; const icon = item.pct >= 0 ? '▲' : '▼'; html += `<div class="ticker-item" onclick="changeTicker('${item.symbol}')"><span class="t-sym">${item.symbol}</span><span class="t-price">${item.price.toFixed(2)}</span><span class="t-chg ${colorClass}">${icon} ${Math.abs(item.pct).toFixed(2)}%</span></div>`; }); return html + `</div>`; }
    
    window.changeTicker = function(sym) { 
        document.getElementById('tickerInput').value = sym; 
        state.ticker = sym; 
        state.tapeTicker = sym; 
        document.getElementById('tapeInput').value = sym;
        document.getElementById('tapeList').innerHTML = ''; state.lastTradeId = 0;
        saveState(); loadInitialData(); 
    };

    function onVisibleLogicalRangeChanged(newVisibleLogicalRange) { if (!newVisibleLogicalRange) return; if (newVisibleLogicalRange.from < 10 && !state.isLoadingHistory && !state.noMoreHistory) loadOlderData(); }
    async function loadOlderData() { if (!state.earliestTime) return; state.isLoadingHistory = true; document.getElementById('history-loader').style.display = 'block'; const keys = await getKeys(); const logicalRange = state.chart.timeScale().getVisibleLogicalRange(); const visibleBars = logicalRange ? Math.ceil(logicalRange.to - logicalRange.from) : 100; const dynamicLimit = Math.min(Math.max(visibleBars * 2, 500), 10000); const endStr = new Date((state.earliestTime - 1) * 1000).toISOString(); const startStr = "2015-01-01T00:00:00Z"; const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/bars?timeframe=${state.timeframe}&start=${startStr}&end=${endStr}&limit=${dynamicLimit}&sort=desc&adjustment=split`; try { const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); const json = await res.json(); if (json.bars && json.bars.length > 0) { const reversedBars = json.bars.reverse(); const oldBars = parseBars(reversedBars); state.masterData = [...oldBars.ohlc, ...state.masterData]; const newVolData = [...oldBars.vol, ...state.series.volume.data()]; state.series.candle.setData(state.masterData); state.series.volume.setData(newVolData); state.earliestTime = oldBars.ohlc[0].time; log(`Stitched ${json.bars.length} older bars.`); } else { state.noMoreHistory = true; } } catch(e) { log(e.message, 'error'); } finally { state.isLoadingHistory = false; document.getElementById('history-loader').style.display = 'none'; } }
    async function loadInitialData() { state.masterData = []; state.earliestTime = null; state.noMoreHistory = false; const keys = await getKeys(); if (!keys) return; const end = new Date().toISOString(); const start = "2020-01-01T00:00:00Z"; const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/bars?timeframe=${state.timeframe}&start=${start}&end=${end}&limit=10000&adjustment=split&sort=desc`; try { const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); const json = await res.json(); if (json.bars && json.bars.length > 0) { const reversedBars = json.bars.reverse(); const data = parseBars(reversedBars); state.masterData = data.ohlc; state.earliestTime = state.masterData[0].time; state.series.candle.setData(data.ohlc); state.series.volume.setData(data.vol); state.chart.timeScale().fitContent(); document.getElementById('lg-header').innerText = `${state.ticker} · ${state.timeframe}`; if (data.ohlc.length > 0) state.lastPrice = data.ohlc[data.ohlc.length-1].close; updateRealtime(); } } catch (e) { log(e.message, 'error'); } }
    async function updateRealtime() { const keys = await getKeys(); if (!keys) return; const url = `https://data.alpaca.markets/v2/stocks/${state.ticker}/snapshot`; try { const res = await fetch(url, { headers: { "APCA-API-KEY-ID": keys.k, "APCA-API-SECRET-KEY": keys.s } }); if (!res.ok) return; const json = await res.json(); const q = json.latestQuote; const t = json.latestTrade; const mb = json.minuteBar; const day = json.dailyBar; if (q) { document.getElementById('q-bid').innerText = `${q.bp.toFixed(2)}x${q.bs}`; document.getElementById('q-ask').innerText = `${q.ap.toFixed(2)}x${q.as}`; } if (t) { const el = document.getElementById('q-last'); el.innerText = t.p.toFixed(2); el.className = 'q-val ' + (t.p >= state.lastPrice ? 'color-up' : 'color-down'); state.lastPrice = t.p; } if (day) document.getElementById('q-vol').innerText = formatNum(day.v); const currentData = state.series.candle.data(); if (currentData.length === 0) return; const lastBar = currentData[currentData.length - 1]; if (state.timeframe === '1D' && day) { const time = snapTime(new Date(day.t).getTime() / 1000, '1D'); updateChartBar(time, day.o, day.h, day.l, day.c, day.v); } else if (state.timeframe.includes('Min') && mb) { const rawTime = new Date(mb.t).getTime() / 1000; const snappedTime = snapTime(rawTime, state.timeframe); const lastBar = currentData[currentData.length - 1]; if (lastBar && snappedTime === lastBar.time) { const newHigh = Math.max(lastBar.high, mb.h); const newLow = Math.min(lastBar.low, mb.l); state.series.candle.update({ time: snappedTime, open: lastBar.open, high: newHigh, low: newLow, close: mb.c }); } else { updateChartBar(snappedTime, mb.o, mb.h, mb.l, mb.c, mb.v); } } else if (state.timeframe === '1H' && t) { const currentData = state.series.candle.data(); if(currentData.length > 0) { const lastBar = currentData[currentData.length - 1]; const newHigh = Math.max(lastBar.high, t.p); const newLow = Math.min(lastBar.low, t.p); state.series.candle.update({ time: lastBar.time, open: lastBar.open, high: newHigh, low: newLow, close: t.p }); } } } catch (e) { } }
    function snapTime(time, tf) { if (tf === '1Min') return Math.floor(time / 60) * 60; if (tf === '5Min') return Math.floor(time / 300) * 300; if (tf === '15Min') return Math.floor(time / 900) * 900; if (tf === '1H') return Math.floor(time / 3600) * 3600; return time; }
    function updateChartBar(time, o, h, l, c, v) { state.series.candle.update({ time: time, open: o, high: h, low: l, close: c }); state.series.volume.update({ time: time, value: v, color: (c >= o ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)') }); }
    function parseBars(bars) { const ohlc = []; const vol = []; bars.forEach(b => { const t = new Date(b.t).getTime() / 1000; ohlc.push({ time: t, open: b.o, high: b.h, low: b.l, close: b.c }); vol.push({ time: t, value: b.v, color: (b.c >= b.o ? 'rgba(38, 166, 154, 0.5)' : 'rgba(239, 83, 80, 0.5)') }); }); return { ohlc, vol }; }
    async function getKeys() { if (typeof getApiKeys !== 'function') return null; const keys = await getApiKeys(); const k = keys.alpacaKey || keys.k || keys.APCA_API_KEY_ID; const s = keys.alpacaSecret || keys.s || keys.APCA_API_SECRET_KEY; if (!k || !s) return null; return { k, s }; }
    function updateLegend(p) { if (!p.time) return; const c = p.seriesData.get(state.series.candle); const v = p.seriesData.get(state.series.volume); if (c) document.getElementById('lg-ohlc').innerHTML = `O:<span class="${c.close >= c.open ? 'color-up':'color-down'}">${c.open.toFixed(2)}</span> H:<span class="${c.close >= c.open ? 'color-up':'color-down'}">${c.high.toFixed(2)}</span> L:<span class="${c.close >= c.open ? 'color-up':'color-down'}">${c.low.toFixed(2)}</span> C:<span class="${c.close >= c.open ? 'color-up':'color-down'}">${c.close.toFixed(2)}</span>`; if (v && c) { const dVol = v.value * c.close; document.getElementById('lg-vol').innerHTML = `V: <span style="color:${v.color}">${formatNum(v.value)}</span> &nbsp;&nbsp; $V: <span style="color:#d1d4dc">$${formatNum(dVol)}</span>`; } }
    async function saveState() { try { const db = await new Promise((r, j) => { const req = indexedDB.open("ProfitLadderDB", 3); req.onsuccess = e => r(e.target.result); req.onerror = j; }); const tx = db.transaction("Settings", "readwrite"); tx.objectStore("Settings").put({ key: "lastChartTicker", value: state.ticker }); tx.objectStore("Settings").put({ key: "lastChartTimeframe", value: state.timeframe }); } catch(e) { } }
    async function loadSavedState() { try { const db = await new Promise((r, j) => { const req = indexedDB.open("ProfitLadderDB", 3); req.onsuccess = e => r(e.target.result); req.onerror = j; }); const tx = db.transaction("Settings", "readonly"); const store = tx.objectStore("Settings"); const tReq = store.get("lastChartTicker"); const tfReq = store.get("lastChartTimeframe"); return new Promise((resolve) => { let loaded = 0; const check = () => { loaded++; if(loaded === 2) resolve(); }; tReq.onsuccess = () => { if(tReq.result) { state.ticker = tReq.result.value; document.getElementById('tickerInput').value = state.ticker; } check(); }; tfReq.onsuccess = () => { if(tfReq.result) { state.timeframe = tfReq.result.value; document.querySelectorAll('.interval-btn').forEach(b => { b.classList.remove('active'); if(b.dataset.tf === state.timeframe) b.classList.add('active'); }); } check(); }; tReq.onerror = check; tfReq.onerror = check; }); } catch(e) { } }

    document.addEventListener('DOMContentLoaded', init);
    const input = document.getElementById('tickerInput');
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { state.ticker = input.value.toUpperCase(); saveState(); loadInitialData(); input.blur(); } });
    document.querySelectorAll('.interval-btn').forEach(b => b.addEventListener('click', () => { document.querySelectorAll('.interval-btn').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); state.timeframe = b.dataset.tf; saveState(); loadInitialData(); }));
    document.getElementById('debugToggle').addEventListener('click', () => logger.style.display = logger.style.display === 'block' ? 'none' : 'block');
    document.getElementById('refreshBtn').addEventListener('click', loadInitialData);
    document.getElementById('settingsBtn').addEventListener('click', () => alert("Manage keys in Portfolio Settings"));
    document.getElementById('clearLogs').addEventListener('click', () => logger.innerHTML = '');
    document.getElementById('tapeToggle').addEventListener('click', toggleTape);
    
    const tapeInput = document.getElementById('tapeInput');
    tapeInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            state.tapeTicker = tapeInput.value.toUpperCase();
            document.getElementById('tapeList').innerHTML = ''; 
            state.lastTradeId = 0; 
            updateTimeAndSales();
            tapeInput.blur();
        }
    });

</script>
</body>
</html>
